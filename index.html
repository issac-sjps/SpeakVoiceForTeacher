<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‹±æ–‡å£èªªå‡ºé¡Œç³»çµ±</title>
    <style>
        body {
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100%;
        }
        
        html {
            height: 100%;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100%;
        }
        
        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }
        
        .card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 20px;
        }
        
        .form-group {
            margin-bottom: 25px;
        }
        
        label {
            display: block;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
            font-size: 1.1rem;
        }
        
        textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            font-size: 16px;
            font-family: inherit;
            resize: vertical;
            transition: border-color 0.3s ease;
        }
        
        textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .generate-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 1.1rem;
            font-weight: 600;
            border-radius: 10px;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            width: 100%;
        }
        
        .generate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .generate-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .result-section {
            display: none;
            margin-top: 30px;
        }
        
        .audio-player {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            margin-bottom: 20px;
        }
        
        .play-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            margin: 0 10px;
            transition: background-color 0.3s ease;
        }
        
        .play-btn:hover {
            background: #218838;
        }
        
        .download-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            margin: 0 10px;
            transition: background-color 0.3s ease;
        }
        
        .download-btn:hover {
            background: #0056b3;
        }
        
        .text-display {
            background: #f8f9fa;
            border-left: 4px solid #667eea;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 15px;
        }
        
        .english-text {
            font-size: 1.2rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 10px;
        }
        
        .chinese-text {
            font-size: 1rem;
            color: #666;
        }
        
        .loading {
            text-align: center;
            color: #667eea;
            font-weight: 600;
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #dc3545;
        }
        
        .success {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #28a745;
        }
        
        .script-editor {
            margin-top: 20px;
        }
        
        .script-item {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            position: relative;
            cursor: move;
            transition: all 0.3s ease;
        }
        
        .script-item:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }
        
        .script-item.dragging {
            opacity: 0.5;
            transform: rotate(5deg);
            z-index: 1000;
        }
        
        .script-item.drag-over {
            border-color: #667eea;
            background: #f0f4ff;
        }
        
        .drag-handle {
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: #6c757d;
            font-size: 18px;
            cursor: grab;
        }
        
        .drag-handle:active {
            cursor: grabbing;
        }
        
        .script-item.text-item {
            border-left: 4px solid #28a745;
            padding-left: 50px;
        }
        
        .script-item.pause-item {
            border-left: 4px solid #ffc107;
            background: #fff8e1;
            padding-left: 50px;
        }
        
        .item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .item-type {
            font-weight: 600;
            color: #495057;
        }
        
        .delete-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .delete-btn:hover {
            background: #c82333;
        }
        
        .text-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
            margin-bottom: 15px;
            resize: vertical;
        }
        
        .voice-select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 14px;
        }
        
        .pause-controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .pause-slider {
            flex: 1;
        }
        
        .pause-value {
            font-weight: 600;
            color: #ffc107;
            min-width: 60px;
        }
        
        .add-buttons {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .add-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s ease;
        }
        
        .add-btn:hover {
            background: #5a6268;
        }
        
        .text-btn {
            background: #28a745;
        }
        
        .text-btn:hover {
            background: #218838;
        }
        
        .pause-btn {
            background: #ffc107;
            color: #212529;
        }
        
        .pause-btn:hover {
            background: #e0a800;
        }
        
        .empty-state {
            text-align: center;
            color: #6c757d;
            padding: 40px;
            border: 2px dashed #dee2e6;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .voice-mode-selector {
            margin-bottom: 30px;
        }
        
        .mode-buttons {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .mode-btn {
            flex: 1;
            padding: 15px 20px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            background: white;
            color: #495057;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .mode-btn:hover {
            border-color: #667eea;
            color: #667eea;
        }
        
        .mode-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
        }
        
        .mode-info {
            margin-top: 15px;
        }
        
        .info-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            border-left: 4px solid #28a745;
        }
        
        .info-card h4 {
            margin: 0 0 15px 0;
            color: #333;
        }
        
        .info-card ul {
            margin: 0;
            padding-left: 20px;
        }
        
        .info-card li {
            margin-bottom: 8px;
            color: #555;
        }
        
        .premium-info {
            border-left-color: #ffc107;
        }
        
        .clear-script-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            margin-left: 10px;
            transition: background-color 0.3s ease;
        }
        
        .clear-script-btn:hover {
            background: #c82333;
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>ğŸ¯ è‹±æ–‡å£èªªå‡ºé¡Œç³»çµ±</h1>
            <p>è¼¸å…¥è‹±æ–‡å’Œä¸­æ–‡åŸæ–‡ï¼Œç”Ÿæˆé“åœ°ç¾å¼ç™¼éŸ³çš„MP3æª”æ¡ˆ</p>
        </header>
        
        <main>
            <div class="card">
                <div class="voice-mode-selector">
                    <h3>ğŸµ èªéŸ³æ¨¡å¼é¸æ“‡</h3>
                    <div class="mode-buttons">
                        <button type="button" class="mode-btn active" id="freeMode">
                            ğŸ†“ å…è²»æ¨¡å¼ (ç€è¦½å™¨å…§å»º)
                        </button>
                        <button type="button" class="mode-btn" id="premiumMode">
                            â­ é«˜å“è³ªæ¨¡å¼ (éœ€è¦ API Key)
                        </button>
                    </div>
                    
                    <div class="api-setup" id="apiSetup" style="display: none;">
                        <div class="form-group">
                            <label for="apiKey">Google Cloud Text-to-Speech API Keyï¼š</label>
                            <input 
                                type="password" 
                                id="apiKey" 
                                placeholder="è«‹è¼¸å…¥æ‚¨çš„ Google Cloud API Key"
                                style="width: 100%; padding: 12px; border: 2px solid #e1e5e9; border-radius: 8px; font-size: 16px;"
                            >
                            <small style="color: #666; display: block; margin-top: 5px;">
                                <strong>ğŸ“‹ è¨­å®šæ­¥é©Ÿï¼š</strong><br>
                                1. åˆ° <a href="https://console.cloud.google.com/" target="_blank" rel="noopener noreferrer">Google Cloud Console</a> å»ºç«‹å°ˆæ¡ˆ<br>
                                2. å•Ÿç”¨ <a href="https://console.cloud.google.com/apis/library/texttospeech.googleapis.com" target="_blank" rel="noopener noreferrer">Text-to-Speech API</a><br>
                                3. åˆ° <a href="https://console.cloud.google.com/apis/credentials" target="_blank" rel="noopener noreferrer">æ†‘è­‰é é¢</a> é»æ“Šã€Œå»ºç«‹æ†‘è­‰ã€<br>
                                4. <strong>âš ï¸ é‡è¦ï¼šé¸æ“‡ã€ŒAPI é‡‘é‘°ã€(ä¸æ˜¯ OAuth 2.0 ç”¨æˆ¶ç«¯ ID)</strong><br>
                                5. è¤‡è£½ç”¢ç”Ÿçš„ API Key ä¸¦è²¼åˆ°ä¸Šæ–¹è¼¸å…¥æ¡†<br>
                                ğŸ’¾ æ‚¨çš„ API Key æœƒè‡ªå‹•å„²å­˜åœ¨é€™å°é›»è…¦ä¸Šï¼Œä¸‹æ¬¡é–‹å•Ÿæœƒè‡ªå‹•è¼‰å…¥
                            </small>
                        </div>
                    </div>
                    
                    <div class="mode-info" id="modeInfo">
                        <div class="info-card free-info">
                            <h4>ğŸ†“ å…è²»æ¨¡å¼ç‰¹è‰²</h4>
                            <ul>
                                <li>âœ… å®Œå…¨å…è²»ï¼Œç„¡éœ€è¨»å†Š</li>
                                <li>âœ… æ”¯æ´å¤šç¨®èªéŸ³é¸é …</li>
                                <li>âœ… å³æ™‚ç”Ÿæˆï¼Œç„¡éœ€ç­‰å¾…</li>
                                <li>âœ… å¯ä¸‹è¼‰éŸ³é »æª”æ¡ˆ (WebM æ ¼å¼)</li>
                                <li>âœ… å¯ä¸‹è¼‰è©³ç´°è…³æœ¬æ–‡å­—æª”</li>
                                <li>âš ï¸ éŸ³è³ªè¼ƒåŸºæœ¬</li>
                                <li>âš ï¸ éŸ³é »æ ¼å¼ç‚º WebM (é MP3)</li>
                            </ul>
                        </div>
                    </div>
                </div>
                
                <div class="script-editor">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3>ğŸ“ èªéŸ³è…³æœ¬ç·¨è¼¯å™¨</h3>
                        <button type="button" class="clear-script-btn" id="clearScriptBtn">
                            ğŸ—‘ï¸ æ¸…ç©ºè…³æœ¬
                        </button>
                    </div>
                    <div id="scriptItems"></div>
                    
                    <div class="add-buttons">
                        <button type="button" class="add-btn text-btn" id="addTextBtn">
                            â• æ–°å¢æ–‡å­—æ®µè½
                        </button>
                        <button type="button" class="add-btn pause-btn" id="addPauseBtn">
                            â¸ï¸ æ–°å¢æš«åœ
                        </button>
                    </div>
                    
                    <button type="button" class="generate-btn" id="generateBtn">
                        ğŸµ ç”Ÿæˆå®Œæ•´èªéŸ³æª”æ¡ˆ
                    </button>
                </div>
            </div>
            
            <div class="card result-section" id="resultSection">
                <h3>ğŸµ èªéŸ³æª”æ¡ˆå·²ç”Ÿæˆ</h3>
                
                <div class="audio-player">
                    <p>æ‚¨çš„èªéŸ³è…³æœ¬å·²æˆåŠŸç”Ÿæˆç‚º MP3 æª”æ¡ˆï¼š</p>
                    <button class="play-btn" id="playBtn">â–¶ï¸ æ’­æ”¾å®Œæ•´èªéŸ³</button>
                    <button class="download-btn" id="downloadBtn">â¬‡ï¸ ä¸‹è¼‰ MP3 æª”æ¡ˆ</button>
                </div>
                
                <div id="statusMessage"></div>
            </div>
        </main>
    </div>

    <script>
        class ScriptBasedSpeechGenerator {
            constructor() {
                this.currentAudio = null;
                this.currentBlob = null;
                this.apiKey = '';
                this.scriptItems = [];
                this.itemCounter = 0;
                this.isPremiumMode = false;
                this.initializeElements();
                this.bindEvents();
                this.loadSavedApiKey();
                this.loadSavedScript();
            }
            
            initializeElements() {
                this.apiKeyInput = document.getElementById('apiKey');
                this.scriptItemsContainer = document.getElementById('scriptItems');
                this.addTextBtn = document.getElementById('addTextBtn');
                this.addPauseBtn = document.getElementById('addPauseBtn');
                this.clearScriptBtn = document.getElementById('clearScriptBtn');
                this.generateBtn = document.getElementById('generateBtn');
                this.resultSection = document.getElementById('resultSection');
                this.playBtn = document.getElementById('playBtn');
                this.downloadBtn = document.getElementById('downloadBtn');
                this.statusMessage = document.getElementById('statusMessage');
                this.freeModeBtn = document.getElementById('freeMode');
                this.premiumModeBtn = document.getElementById('premiumMode');
                this.apiSetup = document.getElementById('apiSetup');
                this.modeInfo = document.getElementById('modeInfo');
            }
            
            bindEvents() {
                this.addTextBtn.addEventListener('click', () => this.addTextItem());
                this.addPauseBtn.addEventListener('click', () => this.addPauseItem());
                this.clearScriptBtn.addEventListener('click', () => this.clearScript());
                this.generateBtn.addEventListener('click', () => this.generateScript());
                this.playBtn.addEventListener('click', () => this.playAudio());
                this.downloadBtn.addEventListener('click', () => this.downloadAudio());
                this.apiKeyInput.addEventListener('input', (e) => this.saveApiKey(e.target.value));
                this.freeModeBtn.addEventListener('click', () => this.switchToFreeMode());
                this.premiumModeBtn.addEventListener('click', () => this.switchToPremiumMode());
            }
            
            loadSavedApiKey() {
                const savedKey = localStorage.getItem('googleAIApiKey');
                if (savedKey) {
                    this.apiKeyInput.value = savedKey;
                    this.apiKey = savedKey;
                    console.log('å·²è¼‰å…¥å„²å­˜çš„ API Key');
                }
            }
            
            loadSavedScript() {
                try {
                    const savedScript = localStorage.getItem('speechScriptItems');
                    if (savedScript) {
                        const parsedScript = JSON.parse(savedScript);
                        if (Array.isArray(parsedScript) && parsedScript.length > 0) {
                            this.scriptItems = parsedScript;
                            // é‡æ–°è¨­å®š itemCounter ç‚ºæœ€å¤§ ID + 1
                            this.itemCounter = Math.max(...parsedScript.map(item => item.id), 0);
                            console.log('å·²è¼‰å…¥å„²å­˜çš„èªéŸ³è…³æœ¬ï¼Œå…±', parsedScript.length, 'å€‹é …ç›®');
                            this.renderScriptItems();
                            this.showMessage('âœ… å·²è‡ªå‹•è¼‰å…¥ä¸Šæ¬¡çš„èªéŸ³è…³æœ¬ï¼', 'success');
                            return;
                        }
                    }
                } catch (error) {
                    console.error('è¼‰å…¥å„²å­˜è…³æœ¬æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                    localStorage.removeItem('speechScriptItems'); // æ¸…é™¤æå£çš„è³‡æ–™
                }
                
                // å¦‚æœæ²’æœ‰å„²å­˜çš„è…³æœ¬æˆ–è¼‰å…¥å¤±æ•—ï¼Œé¡¯ç¤ºç©ºç™½ç‹€æ…‹
                this.showEmptyState();
            }
            
            saveScript() {
                try {
                    localStorage.setItem('speechScriptItems', JSON.stringify(this.scriptItems));
                    console.log('èªéŸ³è…³æœ¬å·²å„²å­˜åˆ°æœ¬æ©Ÿï¼Œå…±', this.scriptItems.length, 'å€‹é …ç›®');
                } catch (error) {
                    console.error('å„²å­˜è…³æœ¬æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                }
            }
            
            clearScript() {
                if (this.scriptItems.length === 0) {
                    this.showMessage('è…³æœ¬å·²ç¶“æ˜¯ç©ºçš„äº†ï¼', 'error');
                    return;
                }
                
                // ç°¡å–®çš„ç¢ºèªæ©Ÿåˆ¶
                const confirmClear = window.confirm('ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰è…³æœ¬å…§å®¹å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚');
                if (confirmClear) {
                    this.scriptItems = [];
                    this.itemCounter = 0;
                    localStorage.removeItem('speechScriptItems');
                    this.showEmptyState();
                    this.showMessage('âœ… è…³æœ¬å·²æ¸…ç©ºï¼', 'success');
                }
            }
            
            saveApiKey(key) {
                this.apiKey = key.trim();
                if (this.apiKey) {
                    localStorage.setItem('googleAIApiKey', this.apiKey);
                    console.log('API Key å·²å„²å­˜åˆ°æœ¬åœ°');
                    this.showMessage('âœ… API Key å·²å„²å­˜ï¼ä¸‹æ¬¡é–‹å•Ÿç¶²é æœƒè‡ªå‹•è¼‰å…¥', 'success');
                } else {
                    localStorage.removeItem('googleAIApiKey');
                    console.log('API Key å·²æ¸…é™¤');
                }
            }
            
            switchToFreeMode() {
                this.isPremiumMode = false;
                this.freeModeBtn.classList.add('active');
                this.premiumModeBtn.classList.remove('active');
                this.apiSetup.style.display = 'none';
                this.updateModeInfo();
                this.renderScriptItems(); // é‡æ–°æ¸²æŸ“ä»¥æ›´æ–°èªéŸ³é¸é …
            }
            
            switchToPremiumMode() {
                this.isPremiumMode = true;
                this.premiumModeBtn.classList.add('active');
                this.freeModeBtn.classList.remove('active');
                this.apiSetup.style.display = 'block';
                this.updateModeInfo();
                this.renderScriptItems(); // é‡æ–°æ¸²æŸ“ä»¥æ›´æ–°èªéŸ³é¸é …
            }
            
            updateModeInfo() {
                if (this.isPremiumMode) {
                    this.modeInfo.innerHTML = `
                        <div class="info-card premium-info">
                            <h4>â­ é«˜å“è³ªæ¨¡å¼ç‰¹è‰²</h4>
                            <ul>
                                <li>âœ… å°ˆæ¥­ç´šèªéŸ³å“è³ª</li>
                                <li>âœ… å¤šç¨®è‡ªç„¶èªéŸ³é¸é …</li>
                                <li>âœ… å¯ä¸‹è¼‰é«˜å“è³ª MP3</li>
                                <li>âœ… æ”¯æ´èªéŸ³åƒæ•¸èª¿æ•´</li>
                                <li>âš ï¸ éœ€è¦ Google Cloud API Key</li>
                            </ul>
                        </div>
                    `;
                } else {
                    this.modeInfo.innerHTML = `
                        <div class="info-card free-info">
                            <h4>ğŸ†“ å…è²»æ¨¡å¼ç‰¹è‰²</h4>
                            <ul>
                                <li>âœ… å®Œå…¨å…è²»ï¼Œç„¡éœ€è¨»å†Š</li>
                                <li>âœ… æ”¯æ´å¤šç¨®èªéŸ³é¸é …</li>
                                <li>âœ… å³æ™‚ç”Ÿæˆï¼Œç„¡éœ€ç­‰å¾…</li>
                                <li>âœ… å¯ä¸‹è¼‰éŸ³é »æª”æ¡ˆ (WebM æ ¼å¼)</li>
                                <li>âœ… å¯ä¸‹è¼‰è©³ç´°è…³æœ¬æ–‡å­—æª”</li>
                                <li>âš ï¸ éŸ³è³ªè¼ƒåŸºæœ¬</li>
                                <li>âš ï¸ éŸ³é »æ ¼å¼ç‚º WebM (é MP3)</li>
                            </ul>
                        </div>
                    `;
                }
            }
            
            getVoiceOptions(selectedVoice) {
                if (this.isPremiumMode) {
                    return `
                        <optgroup label="ğŸ‡ºğŸ‡¸ è‹±èªèªéŸ³ (æ¨è–¦)">
                            <option value="en-US-Journey-D" ${selectedVoice === 'en-US-Journey-D' ? 'selected' : ''}>ç¾å¼è‹±èª (å¥³æ€§) - Journey è‡ªç„¶èªéŸ³</option>
                            <option value="en-US-Journey-F" ${selectedVoice === 'en-US-Journey-F' ? 'selected' : ''}>ç¾å¼è‹±èª (ç”·æ€§) - Journey è‡ªç„¶èªéŸ³</option>
                            <option value="en-US-Studio-O" ${selectedVoice === 'en-US-Studio-O' ? 'selected' : ''}>ç¾å¼è‹±èª (å¥³æ€§) - Studio é«˜å“è³ª</option>
                            <option value="en-US-Studio-Q" ${selectedVoice === 'en-US-Studio-Q' ? 'selected' : ''}>ç¾å¼è‹±èª (ç”·æ€§) - Studio é«˜å“è³ª</option>
                            <option value="en-US-Neural2-C" ${selectedVoice === 'en-US-Neural2-C' ? 'selected' : ''}>ç¾å¼è‹±èª (å¥³æ€§) - Neural2</option>
                            <option value="en-US-Neural2-D" ${selectedVoice === 'en-US-Neural2-D' ? 'selected' : ''}>ç¾å¼è‹±èª (ç”·æ€§) - Neural2</option>
                        </optgroup>
                        <optgroup label="ğŸ‡¹ğŸ‡¼ å°ç£ä¸­æ–‡">
                            <option value="cmn-TW-Standard-A" ${selectedVoice === 'cmn-TW-Standard-A' ? 'selected' : ''}>å°ç£åœ‹èª (å¥³æ€§) - æ¨™æº–</option>
                            <option value="cmn-TW-Standard-B" ${selectedVoice === 'cmn-TW-Standard-B' ? 'selected' : ''}>å°ç£åœ‹èª (ç”·æ€§) - æ¨™æº–</option>
                            <option value="cmn-TW-Wavenet-A" ${selectedVoice === 'cmn-TW-Wavenet-A' ? 'selected' : ''}>å°ç£åœ‹èª (å¥³æ€§) - WaveNet é«˜å“è³ª</option>
                            <option value="cmn-TW-Wavenet-B" ${selectedVoice === 'cmn-TW-Wavenet-B' ? 'selected' : ''}>å°ç£åœ‹èª (ç”·æ€§) - WaveNet é«˜å“è³ª</option>
                        </optgroup>
                        <optgroup label="ğŸ‡¨ğŸ‡³ å¤§é™¸ä¸­æ–‡">
                            <option value="cmn-CN-Standard-A" ${selectedVoice === 'cmn-CN-Standard-A' ? 'selected' : ''}>æ™®é€šè©± (å¥³æ€§) - æ¨™æº–</option>
                            <option value="cmn-CN-Standard-B" ${selectedVoice === 'cmn-CN-Standard-B' ? 'selected' : ''}>æ™®é€šè©± (ç”·æ€§) - æ¨™æº–</option>
                            <option value="cmn-CN-Wavenet-A" ${selectedVoice === 'cmn-CN-Wavenet-A' ? 'selected' : ''}>æ™®é€šè©± (å¥³æ€§) - WaveNet é«˜å“è³ª</option>
                            <option value="cmn-CN-Wavenet-B" ${selectedVoice === 'cmn-CN-Wavenet-B' ? 'selected' : ''}>æ™®é€šè©± (ç”·æ€§) - WaveNet é«˜å“è³ª</option>
                        </optgroup>
                    `;
                } else {
                    return `
                        <optgroup label="ğŸ‡ºğŸ‡¸ è‹±èªèªéŸ³">
                            <option value="Microsoft Zira - English (United States)" ${selectedVoice === 'Microsoft Zira - English (United States)' ? 'selected' : ''}>ç¾å¼è‹±èª (å¥³æ€§)</option>
                            <option value="Microsoft David - English (United States)" ${selectedVoice === 'Microsoft David - English (United States)' ? 'selected' : ''}>ç¾å¼è‹±èª (ç”·æ€§)</option>
                            <option value="Google US English" ${selectedVoice === 'Google US English' ? 'selected' : ''}>Google ç¾å¼è‹±èª</option>
                            <option value="native" ${selectedVoice === 'native' ? 'selected' : ''}>ç³»çµ±é è¨­è‹±èª</option>
                        </optgroup>
                        <optgroup label="ğŸ‡¹ğŸ‡¼ ä¸­æ–‡èªéŸ³">
                            <option value="Microsoft Hanhan - Chinese (Taiwan)" ${selectedVoice === 'Microsoft Hanhan - Chinese (Taiwan)' ? 'selected' : ''}>å°ç£ä¸­æ–‡ (å¥³æ€§)</option>
                            <option value="Microsoft Zhiwei - Chinese (Taiwan)" ${selectedVoice === 'Microsoft Zhiwei - Chinese (Taiwan)' ? 'selected' : ''}>å°ç£ä¸­æ–‡ (ç”·æ€§)</option>
                            <option value="Google åœ‹èªï¼ˆè‡ºç£ï¼‰" ${selectedVoice === 'Google åœ‹èªï¼ˆè‡ºç£ï¼‰' ? 'selected' : ''}>Google å°ç£åœ‹èª</option>
                            <option value="Microsoft Yaoyao - Chinese (Mainland)" ${selectedVoice === 'Microsoft Yaoyao - Chinese (Mainland)' ? 'selected' : ''}>å¤§é™¸æ™®é€šè©± (å¥³æ€§)</option>
                            <option value="Microsoft Kangkang - Chinese (Mainland)" ${selectedVoice === 'Microsoft Kangkang - Chinese (Mainland)' ? 'selected' : ''}>å¤§é™¸æ™®é€šè©± (ç”·æ€§)</option>
                            <option value="Google æ™®é€šè¯ï¼ˆä¸­å›½å¤§é™†ï¼‰" ${selectedVoice === 'Google æ™®é€šè¯ï¼ˆä¸­å›½å¤§é™†ï¼‰' ? 'selected' : ''}>Google å¤§é™¸æ™®é€šè©±</option>
                        </optgroup>
                    `;
                }
            }
            
            showEmptyState() {
                if (this.scriptItems.length === 0) {
                    this.scriptItemsContainer.innerHTML = `
                        <div class="empty-state">
                            <h4>ğŸ“ é–‹å§‹å»ºç«‹æ‚¨çš„èªéŸ³è…³æœ¬</h4>
                            <p>é»æ“Šä¸‹æ–¹æŒ‰éˆ•æ–°å¢æ–‡å­—æ®µè½æˆ–æš«åœæ™‚é–“</p>
                            <p style="color: #28a745; font-weight: 600;">ğŸ’¾ æ‚¨çš„è…³æœ¬æœƒè‡ªå‹•å„²å­˜åœ¨é€™å°é›»è…¦ä¸Š</p>
                        </div>
                    `;
                }
            }
            
            addTextItem() {
                const itemId = ++this.itemCounter;
                const defaultVoice = this.isPremiumMode ? 'en-US-Journey-D' : 'Microsoft Zira - English (United States)';
                const item = {
                    id: itemId,
                    type: 'text',
                    text: '',
                    voice: defaultVoice
                };
                
                this.scriptItems.push(item);
                this.renderScriptItems();
                this.saveScript(); // è‡ªå‹•å„²å­˜
            }
            
            addPauseItem() {
                const itemId = ++this.itemCounter;
                const item = {
                    id: itemId,
                    type: 'pause',
                    duration: 2.0
                };
                
                this.scriptItems.push(item);
                this.renderScriptItems();
                this.saveScript(); // è‡ªå‹•å„²å­˜
            }
            
            renderScriptItems() {
                if (this.scriptItems.length === 0) {
                    this.showEmptyState();
                    return;
                }
                
                this.scriptItemsContainer.innerHTML = this.scriptItems.map(item => {
                    if (item.type === 'text') {
                        return this.renderTextItem(item);
                    } else {
                        return this.renderPauseItem(item);
                    }
                }).join('');
                
                // é‡æ–°ç¶å®šäº‹ä»¶
                this.bindItemEvents();
            }
            
            renderTextItem(item) {
                return `
                    <div class="script-item text-item" data-id="${item.id}" draggable="true">
                        <div class="drag-handle">â‹®â‹®</div>
                        <div class="item-header">
                            <span class="item-type">ğŸ—£ï¸ æ–‡å­—æ®µè½</span>
                            <button class="delete-btn" onclick="generator.deleteItem(${item.id})">åˆªé™¤</button>
                        </div>
                        <textarea 
                            class="text-input" 
                            placeholder="è«‹è¼¸å…¥è¦æœ—è®€çš„æ–‡å­—..."
                            rows="3"
                            onchange="generator.updateItemText(${item.id}, this.value)"
                        >${item.text}</textarea>
                        <select 
                            class="voice-select" 
                            onchange="generator.updateItemVoice(${item.id}, this.value)"
                        >
                            ${generator.getVoiceOptions(item.voice)}
                        </select>
                    </div>
                `;
            }
            
            renderPauseItem(item) {
                return `
                    <div class="script-item pause-item" data-id="${item.id}" draggable="true">
                        <div class="drag-handle">â‹®â‹®</div>
                        <div class="item-header">
                            <span class="item-type">â¸ï¸ æš«åœæ™‚é–“</span>
                            <button class="delete-btn" onclick="generator.deleteItem(${item.id})">åˆªé™¤</button>
                        </div>
                        <div class="pause-controls">
                            <input 
                                type="range" 
                                class="pause-slider" 
                                min="0.5" 
                                max="10" 
                                step="0.5" 
                                value="${item.duration}"
                                oninput="generator.updatePauseDuration(${item.id}, this.value)"
                            >
                            <span class="pause-value">${item.duration.toFixed(1)} ç§’</span>
                        </div>
                    </div>
                `;
            }
            
            bindItemEvents() {
                // ç¶å®šæ‹–æ‹½äº‹ä»¶
                const scriptItems = this.scriptItemsContainer.querySelectorAll('.script-item');
                scriptItems.forEach(item => {
                    item.addEventListener('dragstart', (e) => this.handleDragStart(e));
                    item.addEventListener('dragover', (e) => this.handleDragOver(e));
                    item.addEventListener('drop', (e) => this.handleDrop(e));
                    item.addEventListener('dragend', (e) => this.handleDragEnd(e));
                    item.addEventListener('dragenter', (e) => this.handleDragEnter(e));
                    item.addEventListener('dragleave', (e) => this.handleDragLeave(e));
                });
            }
            
            updateItemText(itemId, text) {
                const item = this.scriptItems.find(i => i.id === itemId);
                if (item) {
                    item.text = text;
                    this.saveScript(); // è‡ªå‹•å„²å­˜
                }
            }
            
            updateItemVoice(itemId, voice) {
                const item = this.scriptItems.find(i => i.id === itemId);
                if (item) {
                    item.voice = voice;
                    this.saveScript(); // è‡ªå‹•å„²å­˜
                }
            }
            
            updatePauseDuration(itemId, duration) {
                const item = this.scriptItems.find(i => i.id === itemId);
                if (item) {
                    item.duration = parseFloat(duration);
                    // æ›´æ–°é¡¯ç¤º
                    const pauseValue = document.querySelector(`[data-id="${itemId}"] .pause-value`);
                    if (pauseValue) {
                        pauseValue.textContent = `${parseFloat(duration).toFixed(1)} ç§’`;
                    }
                    this.saveScript(); // è‡ªå‹•å„²å­˜
                }
            }
            
            deleteItem(itemId) {
                this.scriptItems = this.scriptItems.filter(item => item.id !== itemId);
                this.renderScriptItems();
                this.saveScript(); // è‡ªå‹•å„²å­˜
            }
            
            // æ‹–æ‹½è™•ç†å‡½æ•¸
            handleDragStart(e) {
                this.draggedItemId = parseInt(e.target.dataset.id);
                e.target.classList.add('dragging');
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setData('text/html', e.target.outerHTML);
            }
            
            handleDragOver(e) {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
            }
            
            handleDragEnter(e) {
                e.preventDefault();
                if (e.target.classList.contains('script-item') && 
                    parseInt(e.target.dataset.id) !== this.draggedItemId) {
                    e.target.classList.add('drag-over');
                }
            }
            
            handleDragLeave(e) {
                if (e.target.classList.contains('script-item')) {
                    e.target.classList.remove('drag-over');
                }
            }
            
            handleDrop(e) {
                e.preventDefault();
                const targetId = parseInt(e.target.closest('.script-item').dataset.id);
                
                if (targetId && targetId !== this.draggedItemId) {
                    this.reorderItems(this.draggedItemId, targetId);
                }
                
                // æ¸…é™¤æ‰€æœ‰æ‹–æ‹½æ¨£å¼
                this.scriptItemsContainer.querySelectorAll('.script-item').forEach(item => {
                    item.classList.remove('drag-over');
                });
            }
            
            handleDragEnd(e) {
                e.target.classList.remove('dragging');
                this.draggedItemId = null;
                
                // æ¸…é™¤æ‰€æœ‰æ‹–æ‹½æ¨£å¼
                this.scriptItemsContainer.querySelectorAll('.script-item').forEach(item => {
                    item.classList.remove('drag-over', 'dragging');
                });
            }
            
            reorderItems(draggedId, targetId) {
                const draggedIndex = this.scriptItems.findIndex(item => item.id === draggedId);
                const targetIndex = this.scriptItems.findIndex(item => item.id === targetId);
                
                if (draggedIndex === -1 || targetIndex === -1) return;
                
                // ç§»é™¤è¢«æ‹–æ‹½çš„é …ç›®
                const draggedItem = this.scriptItems.splice(draggedIndex, 1)[0];
                
                // æ’å…¥åˆ°ç›®æ¨™ä½ç½®
                this.scriptItems.splice(targetIndex, 0, draggedItem);
                
                // é‡æ–°æ¸²æŸ“
                this.renderScriptItems();
                this.saveScript(); // è‡ªå‹•å„²å­˜
                
                // é¡¯ç¤ºæˆåŠŸè¨Šæ¯
                this.showMessage('âœ… æ®µè½é †åºå·²æ›´æ–°ï¼', 'success');
            }
            
            async generateScript() {
                if (this.isPremiumMode && !this.apiKey) {
                    this.showMessage('é«˜å“è³ªæ¨¡å¼éœ€è¦ Google Cloud API Keyï¼Œè«‹å…ˆè¼¸å…¥æˆ–åˆ‡æ›åˆ°å…è²»æ¨¡å¼', 'error');
                    return;
                }
                
                if (this.scriptItems.length === 0) {
                    this.showMessage('è«‹å…ˆæ–°å¢ä¸€äº›æ–‡å­—æ®µè½æˆ–æš«åœæ™‚é–“', 'error');
                    return;
                }
                
                // æª¢æŸ¥æ˜¯å¦æœ‰æ–‡å­—å…§å®¹
                const hasText = this.scriptItems.some(item => item.type === 'text' && item.text.trim());
                if (!hasText) {
                    this.showMessage('è«‹è‡³å°‘æ–°å¢ä¸€å€‹åŒ…å«æ–‡å­—çš„æ®µè½', 'error');
                    return;
                }
                
                this.generateBtn.disabled = true;
                this.generateBtn.textContent = 'ğŸ”„ ç”Ÿæˆä¸­...';
                this.showMessage('æ­£åœ¨ç”ŸæˆèªéŸ³æª”æ¡ˆï¼Œè«‹ç¨å€™...', 'loading');
                
                try {
                    if (this.isPremiumMode) {
                        await this.generateSpeechWithAPI();
                    } else {
                        await this.generateSpeechWithBrowser();
                    }
                } catch (error) {
                    this.showMessage(`ç”ŸæˆèªéŸ³æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š${error.message}`, 'error');
                    console.error('Speech generation error:', error);
                } finally {
                    this.generateBtn.disabled = false;
                    this.generateBtn.textContent = 'ğŸµ ç”Ÿæˆå®Œæ•´èªéŸ³æª”æ¡ˆ';
                }
            }
            
            async generateSpeechWithAPI() {
                console.log('é–‹å§‹ç”ŸæˆèªéŸ³ï¼ŒAPI Key:', this.apiKey ? 'å·²è¨­å®š' : 'æœªè¨­å®š');
                console.log('è…³æœ¬é …ç›®æ•¸é‡:', this.scriptItems.length);
                
                // å»ºç«‹ç°¡åŒ–çš„æ–‡å­—å…§å®¹ï¼ˆä¸ä½¿ç”¨è¤‡é›œçš„ SSMLï¼‰
                let textContent = '';
                
                for (const item of this.scriptItems) {
                    if (item.type === 'text' && item.text.trim()) {
                        textContent += item.text.trim() + ' ';
                        console.log('æ·»åŠ æ–‡å­—:', item.text.trim());
                    } else if (item.type === 'pause') {
                        // ç”¨å¥è™Ÿä¾†æ¨¡æ“¬æš«åœ
                        textContent += '. ';
                        console.log('æ·»åŠ æš«åœ:', item.duration + 'ç§’');
                    }
                }
                
                if (!textContent.trim()) {
                    throw new Error('æ²’æœ‰æ‰¾åˆ°è¦æœ—è®€çš„æ–‡å­—å…§å®¹');
                }
                
                console.log('æœ€çµ‚æ–‡å­—å…§å®¹:', textContent);
                
                // ä½¿ç”¨ç¬¬ä¸€å€‹æ–‡å­—é …ç›®çš„èªéŸ³è¨­å®š
                const firstTextItem = this.scriptItems.find(item => item.type === 'text');
                const voiceName = firstTextItem ? firstTextItem.voice : 'en-US-Journey-D';
                
                // æ ¹æ“šèªéŸ³åç¨±è‡ªå‹•åˆ¤æ–·èªè¨€ä»£ç¢¼
                const getLanguageCode = (voiceName) => {
                    if (voiceName.startsWith('en-US') || voiceName.includes('English (United States)')) return 'en-US';
                    if (voiceName.startsWith('en-GB') || voiceName.includes('English (United Kingdom)')) return 'en-GB';
                    if (voiceName.startsWith('cmn-TW') || voiceName.includes('Chinese (Taiwan)')) return 'cmn-TW';
                    if (voiceName.startsWith('cmn-CN') || voiceName.includes('Chinese (Mainland)')) return 'cmn-CN';
                    return 'en-US'; // é è¨­
                };
                
                const languageCode = getLanguageCode(voiceName);
                
                try {
                    console.log('ç™¼é€ API è«‹æ±‚...');
                    const requestBody = {
                        input: {
                            text: textContent.trim()
                        },
                        voice: {
                            languageCode: languageCode,
                            name: voiceName
                        },
                        audioConfig: {
                            audioEncoding: 'MP3',
                            speakingRate: 0.9,
                            pitch: 0.0,
                            volumeGainDb: 0.0
                        }
                    };
                    
                    console.log('è«‹æ±‚å…§å®¹:', requestBody);
                    
                    const response = await fetch(`https://texttospeech.googleapis.com/v1/text:synthesize?key=${this.apiKey}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(requestBody)
                    });
                    
                    console.log('API å›æ‡‰ç‹€æ…‹:', response.status);
                    
                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('API éŒ¯èª¤å›æ‡‰:', errorText);
                        let errorData;
                        try {
                            errorData = JSON.parse(errorText);
                        } catch (e) {
                            throw new Error(`API è«‹æ±‚å¤±æ•— (${response.status}): ${errorText}`);
                        }
                        throw new Error(errorData.error?.message || `API è«‹æ±‚å¤±æ•— (${response.status})`);
                    }
                    
                    const data = await response.json();
                    console.log('API å›æ‡‰æˆåŠŸï¼ŒéŸ³é »å…§å®¹é•·åº¦:', data.audioContent ? data.audioContent.length : 0);
                    
                    if (!data.audioContent) {
                        throw new Error('API å›æ‡‰ä¸­æ²’æœ‰éŸ³é »å…§å®¹');
                    }
                    
                    // å°‡ base64 éŸ³é »è½‰æ›ç‚º Blob
                    const audioBytes = atob(data.audioContent);
                    const audioArray = new Uint8Array(audioBytes.length);
                    for (let i = 0; i < audioBytes.length; i++) {
                        audioArray[i] = audioBytes.charCodeAt(i);
                    }
                    
                    this.currentBlob = new Blob([audioArray], { type: 'audio/mpeg' });
                    this.currentAudio = new Audio(URL.createObjectURL(this.currentBlob));
                    
                    console.log('éŸ³é »æª”æ¡ˆç”ŸæˆæˆåŠŸï¼Œå¤§å°:', this.currentBlob.size, 'bytes');
                    
                    // é¡¯ç¤ºçµæœ
                    this.displayResults();
                    
                } catch (error) {
                    console.error('Google API éŒ¯èª¤:', error);
                    
                    // æª¢æŸ¥ä¸åŒé¡å‹çš„ API éŒ¯èª¤
                    if (error.message.includes('has not been used') || error.message.includes('is disabled')) {
                        this.showMessage(`
                            âŒ <strong>Google Text-to-Speech API å°šæœªå•Ÿç”¨ï¼</strong><br><br>
                            <strong>ğŸ“‹ è«‹æŒ‰ç…§ä»¥ä¸‹æ­¥é©Ÿè¨­å®šï¼š</strong><br>
                            1. å‰å¾€ <a href="https://console.cloud.google.com/" target="_blank" rel="noopener noreferrer" style="color: #007bff; font-weight: bold;">Google Cloud Console</a><br>
                            2. é¸æ“‡æˆ–å»ºç«‹ä¸€å€‹å°ˆæ¡ˆ<br>
                            3. å•Ÿç”¨ <a href="https://console.cloud.google.com/apis/library/texttospeech.googleapis.com" target="_blank" rel="noopener noreferrer" style="color: #007bff; font-weight: bold;">Text-to-Speech API</a><br>
                            4. åˆ° <a href="https://console.cloud.google.com/apis/credentials" target="_blank" rel="noopener noreferrer" style="color: #007bff; font-weight: bold;">æ†‘è­‰é é¢</a> å»ºç«‹ API Key<br>
                            5. å°‡æ–°çš„ API Key è²¼åˆ°ä¸Šæ–¹è¼¸å…¥æ¡†<br><br>
                            ğŸ’¡ <strong>æç¤ºï¼š</strong>å•Ÿç”¨ API å¾Œå¯èƒ½éœ€è¦ç­‰å¾…å¹¾åˆ†é˜æ‰èƒ½ä½¿ç”¨<br>
                            ğŸ”„ <strong>æˆ–è€…æ‚¨å¯ä»¥æ‰‹å‹•åˆ‡æ›åˆ°å…è²»æ¨¡å¼</strong>
                        `, 'error');
                    } else if (error.message.includes('blocked') || error.message.includes('PERMISSION_DENIED') || error.message.includes('API_KEY_SERVICE_BLOCKED')) {
                        this.showMessage(`
                            ğŸš« <strong>API æœå‹™è¢«é˜»æ“‹ï¼(éŒ¯èª¤ä»£ç¢¼: 403)</strong><br><br>
                            æ‚¨çš„ Google Cloud å°ˆæ¡ˆä¸­ Text-to-Speech API æœå‹™è¢«é˜»æ“‹ã€‚é€™é€šå¸¸æ˜¯å› ç‚ºï¼š<br><br>
                            
                            <strong>ğŸ”§ ä¸»è¦è§£æ±ºæ–¹æ¡ˆï¼š</strong><br>
                            1. <strong>å•Ÿç”¨è¨ˆè²»å¸³æˆ¶ï¼š</strong>å‰å¾€ <a href="https://console.cloud.google.com/billing" target="_blank" rel="noopener noreferrer" style="color: #007bff; font-weight: bold;">Google Cloud è¨ˆè²»é é¢</a><br>
                            &nbsp;&nbsp;&nbsp;â€¢ æ–°å°ˆæ¡ˆå¿…é ˆå•Ÿç”¨è¨ˆè²»æ‰èƒ½ä½¿ç”¨ Text-to-Speech API<br>
                            &nbsp;&nbsp;&nbsp;â€¢ å³ä½¿åœ¨å…è²»é¡åº¦å…§ä¹Ÿéœ€è¦ç¶å®šä¿¡ç”¨å¡<br><br>
                            
                            2. <strong>é‡æ–°å•Ÿç”¨ APIï¼š</strong>å‰å¾€ <a href="https://console.cloud.google.com/apis/library/texttospeech.googleapis.com" target="_blank" rel="noopener noreferrer" style="color: #007bff; font-weight: bold;">Text-to-Speech API é é¢</a><br>
                            &nbsp;&nbsp;&nbsp;â€¢ å¦‚æœé¡¯ç¤ºã€Œå·²å•Ÿç”¨ã€ï¼Œè«‹å…ˆåœç”¨å†é‡æ–°å•Ÿç”¨<br>
                            &nbsp;&nbsp;&nbsp;â€¢ ç­‰å¾… 2-5 åˆ†é˜è®“è¨­å®šç”Ÿæ•ˆ<br><br>
                            
                            3. <strong>é‡æ–°å»ºç«‹ API Keyï¼š</strong>åˆ° <a href="https://console.cloud.google.com/apis/credentials" target="_blank" rel="noopener noreferrer" style="color: #007bff; font-weight: bold;">æ†‘è­‰é é¢</a><br>
                            &nbsp;&nbsp;&nbsp;â€¢ åˆªé™¤èˆŠçš„ API Key<br>
                            &nbsp;&nbsp;&nbsp;â€¢ å»ºç«‹æ–°çš„ API Key<br>
                            &nbsp;&nbsp;&nbsp;â€¢ ç¢ºä¿ API Key æœ‰æ­£ç¢ºçš„æ¬Šé™<br><br>
                            
                            ğŸ”„ <strong>ç«‹å³è§£æ±ºæ–¹æ¡ˆï¼šæ‰‹å‹•åˆ‡æ›åˆ°å…è²»æ¨¡å¼ä½¿ç”¨ç€è¦½å™¨å…§å»ºèªéŸ³</strong>
                        `, 'error');
                    } else if (error.message.includes('API key not valid') || error.message.includes('INVALID_ARGUMENT') || error.message.includes('400')) {
                        this.showMessage(`
                            ğŸ”‘ <strong>API Key ç„¡æ•ˆï¼</strong><br><br>
                            <strong>è«‹æª¢æŸ¥ä»¥ä¸‹é …ç›®ï¼š</strong><br>
                            â€¢ API Key æ˜¯å¦æ­£ç¢ºè¤‡è£½ï¼ˆæ²’æœ‰å¤šé¤˜ç©ºæ ¼ï¼‰<br>
                            â€¢ API Key æ˜¯å¦å·²éæœŸæˆ–è¢«åˆªé™¤<br>
                            â€¢ æ˜¯å¦ä½¿ç”¨äº†æ­£ç¢ºçš„ Google Cloud å°ˆæ¡ˆ<br>
                            â€¢ API Key æ˜¯å¦æœ‰æ­£ç¢ºçš„æ¬Šé™è¨­å®š<br><br>
                            
                            <strong>ğŸ”§ è§£æ±ºæ­¥é©Ÿï¼š</strong><br>
                            1. åˆ° <a href="https://console.cloud.google.com/apis/credentials" target="_blank" rel="noopener noreferrer" style="color: #007bff; font-weight: bold;">Google Cloud æ†‘è­‰é é¢</a><br>
                            2. æª¢æŸ¥ç¾æœ‰ API Key æˆ–å»ºç«‹æ–°çš„ API Key<br>
                            3. ç¢ºä¿ API Key æœ‰ Text-to-Speech API æ¬Šé™<br>
                            4. é‡æ–°è¤‡è£½ä¸¦è²¼ä¸Šæ–°çš„ API Key<br><br>
                            
                            ğŸ”„ <strong>æˆ–è€…æ‚¨å¯ä»¥æ‰‹å‹•åˆ‡æ›åˆ°å…è²»æ¨¡å¼</strong>
                        `, 'error');
                    } else {
                        // å…¶ä»– API éŒ¯èª¤ï¼Œä¸è‡ªå‹•åˆ‡æ›
                        this.showMessage(`
                            âŒ <strong>Google API ç™¼ç”ŸéŒ¯èª¤ï¼š</strong>${error.message}<br><br>
                            <strong>å»ºè­°è§£æ±ºæ–¹æ¡ˆï¼š</strong><br>
                            â€¢ æª¢æŸ¥ç¶²è·¯é€£ç·šæ˜¯å¦æ­£å¸¸<br>
                            â€¢ ç¢ºèª API Key è¨­å®šæ­£ç¢º<br>
                            â€¢ æª¢æŸ¥ Google Cloud å°ˆæ¡ˆç‹€æ…‹<br>
                            â€¢ ç¢ºèª Text-to-Speech API å·²å•Ÿç”¨<br><br>
                            ğŸ”„ <strong>æ‚¨å¯ä»¥æ‰‹å‹•åˆ‡æ›åˆ°å…è²»æ¨¡å¼ä½¿ç”¨ç€è¦½å™¨å…§å»ºèªéŸ³</strong>
                        `, 'error');
                    }
                }
            }
            
            async generateSpeechWithBrowser() {
                if (!('speechSynthesis' in window)) {
                    throw new Error('æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³åˆæˆåŠŸèƒ½');
                }
                
                console.log('ä½¿ç”¨ç€è¦½å™¨å…§å»ºèªéŸ³åˆæˆ');
                
                // åœæ­¢ä»»ä½•æ­£åœ¨æ’­æ”¾çš„èªéŸ³
                speechSynthesis.cancel();
                
                // ç­‰å¾…èªéŸ³åˆ—è¡¨è¼‰å…¥å®Œæˆ
                await this.waitForVoices();
                
                // å»ºç«‹èªéŸ³è…³æœ¬
                this.speechQueue = [];
                
                for (const item of this.scriptItems) {
                    if (item.type === 'text' && item.text.trim()) {
                        const utterance = new SpeechSynthesisUtterance(item.text.trim());
                        
                        // è¨­å®šèªéŸ³åƒæ•¸
                        utterance.rate = 0.9;
                        utterance.pitch = 1.0;
                        utterance.volume = 1.0;
                        
                        // å˜—è©¦è¨­å®šæŒ‡å®šçš„èªéŸ³
                        const voices = speechSynthesis.getVoices();
                        let selectedVoice = null;
                        
                        console.log('å¯ç”¨èªéŸ³æ•¸é‡:', voices.length);
                        console.log('å‰5å€‹èªéŸ³:', voices.slice(0, 5).map(v => `${v.name} (${v.lang})`));
                        
                        // æ ¹æ“šèªéŸ³åç¨±è¨­å®šèªè¨€å’ŒèªéŸ³
                        if (item.voice === 'native') {
                            selectedVoice = voices.find(voice => 
                                voice.lang.includes('zh') || 
                                voice.lang.includes('en')
                            ) || voices[0];
                            utterance.lang = selectedVoice ? selectedVoice.lang : 'zh-TW';
                        } else if (item.voice.includes('Chinese (Taiwan)') || item.voice.includes('è‡ºç£') || item.voice.includes('å°ç£')) {
                            selectedVoice = voices.find(voice => 
                                voice.name.includes('Hanhan') || 
                                voice.name.includes('Zhiwei') ||
                                voice.lang.includes('zh-TW') ||
                                voice.lang.includes('zh-Hant')
                            ) || voices.find(voice => voice.lang.includes('zh'));
                            utterance.lang = 'zh-TW';
                        } else if (item.voice.includes('Chinese (Mainland)') || item.voice.includes('ä¸­å›½å¤§é™†') || item.voice.includes('æ™®é€šè¯')) {
                            selectedVoice = voices.find(voice => 
                                voice.name.includes('Yaoyao') || 
                                voice.name.includes('Kangkang') ||
                                voice.lang.includes('zh-CN') ||
                                voice.lang.includes('zh-Hans')
                            ) || voices.find(voice => voice.lang.includes('zh'));
                            utterance.lang = 'zh-CN';
                        } else if (item.voice.includes('English')) {
                            selectedVoice = voices.find(voice => 
                                voice.name.includes('Zira') || 
                                voice.name.includes('David') ||
                                voice.lang.includes('en-US')
                            ) || voices.find(voice => voice.lang.includes('en'));
                            utterance.lang = 'en-US';
                        } else {
                            // å˜—è©¦ç›´æ¥åŒ¹é…èªéŸ³åç¨±
                            selectedVoice = voices.find(voice => 
                                voice.name.includes(item.voice) || 
                                voice.name === item.voice
                            );
                            if (!selectedVoice) {
                                // ä½¿ç”¨é è¨­èªéŸ³
                                selectedVoice = voices.find(voice => voice.default) || voices[0];
                                utterance.lang = selectedVoice ? selectedVoice.lang : 'en-US';
                            } else {
                                utterance.lang = selectedVoice.lang;
                            }
                        }
                        
                        if (selectedVoice) {
                            utterance.voice = selectedVoice;
                            console.log('é¸æ“‡èªéŸ³:', selectedVoice.name, 'èªè¨€:', selectedVoice.lang);
                        } else {
                            console.log('ä½¿ç”¨é è¨­èªéŸ³ï¼Œèªè¨€:', utterance.lang);
                        }
                        
                        this.speechQueue.push({
                            type: 'speech',
                            utterance: utterance,
                            text: item.text.trim()
                        });
                        
                        console.log('æ·»åŠ èªéŸ³:', item.text.trim(), 'èªéŸ³:', selectedVoice?.name || 'é è¨­');
                        
                    } else if (item.type === 'pause') {
                        this.speechQueue.push({
                            type: 'pause',
                            duration: item.duration * 1000 // è½‰æ›ç‚ºæ¯«ç§’
                        });
                        console.log('æ·»åŠ æš«åœ:', item.duration + 'ç§’');
                    }
                }
                
                if (this.speechQueue.length === 0) {
                    throw new Error('æ²’æœ‰æ‰¾åˆ°è¦æœ—è®€çš„å…§å®¹');
                }
                
                // è¨­å®šæ’­æ”¾æ§åˆ¶
                this.currentAudio = {
                    play: () => this.playBrowserSpeech(),
                    pause: () => speechSynthesis.cancel(),
                    currentTime: 0,
                    onended: null,
                    onerror: null
                };
                
                // æ¸¬è©¦èªéŸ³æ’­æ”¾
                await this.testSpeechSynthesis();
                
                // ç”ŸæˆéŸ³é »æª”æ¡ˆ
                await this.generateAudioFromBrowserSpeech();
                
                // é¡¯ç¤ºçµæœ
                this.displayResults();
                this.showMessage('ğŸµ å…è²»èªéŸ³å·²æº–å‚™å®Œæˆï¼æ‚¨å¯ä»¥æ’­æ”¾è©¦è½æˆ–ä¸‹è¼‰éŸ³é »æª”æ¡ˆã€‚', 'success');
            }
            
            // ç­‰å¾…èªéŸ³åˆ—è¡¨è¼‰å…¥çš„è¼”åŠ©å‡½æ•¸
            waitForVoices() {
                return new Promise((resolve) => {
                    const voices = speechSynthesis.getVoices();
                    if (voices.length > 0) {
                        console.log('èªéŸ³åˆ—è¡¨å·²è¼‰å…¥ï¼Œå…±', voices.length, 'å€‹èªéŸ³');
                        resolve();
                        return;
                    }
                    
                    console.log('ç­‰å¾…èªéŸ³åˆ—è¡¨è¼‰å…¥...');
                    let attempts = 0;
                    const maxAttempts = 10;
                    
                    const checkVoices = () => {
                        const voices = speechSynthesis.getVoices();
                        attempts++;
                        
                        if (voices.length > 0) {
                            console.log('èªéŸ³åˆ—è¡¨è¼‰å…¥å®Œæˆï¼Œå…±', voices.length, 'å€‹èªéŸ³');
                            resolve();
                        } else if (attempts >= maxAttempts) {
                            console.log('èªéŸ³åˆ—è¡¨è¼‰å…¥è¶…æ™‚ï¼Œä½¿ç”¨é è¨­è¨­å®š');
                            resolve();
                        } else {
                            setTimeout(checkVoices, 100);
                        }
                    };
                    
                    // ç›£è½èªéŸ³è®Šæ›´äº‹ä»¶
                    speechSynthesis.addEventListener('voiceschanged', () => {
                        console.log('èªéŸ³åˆ—è¡¨å·²æ›´æ–°');
                        resolve();
                    }, { once: true });
                    
                    // é–‹å§‹æª¢æŸ¥
                    setTimeout(checkVoices, 100);
                });
            }
            
            async testSpeechSynthesis() {
                try {
                    console.log('æ¸¬è©¦èªéŸ³åˆæˆåŠŸèƒ½...');
                    
                    // æª¢æŸ¥ç€è¦½å™¨æ”¯æ´
                    if (!window.speechSynthesis) {
                        throw new Error('ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³åˆæˆ');
                    }
                    
                    // æ¸¬è©¦ç°¡å–®èªéŸ³
                    const testUtterance = new SpeechSynthesisUtterance('æ¸¬è©¦');
                    testUtterance.volume = 0.1; // ä½éŸ³é‡æ¸¬è©¦
                    testUtterance.rate = 1.0;
                    
                    const voices = speechSynthesis.getVoices();
                    if (voices.length > 0) {
                        testUtterance.voice = voices[0];
                        console.log('æ¸¬è©¦èªéŸ³:', voices[0].name);
                    }
                    
                    // å¿«é€Ÿæ¸¬è©¦æ’­æ”¾
                    speechSynthesis.speak(testUtterance);
                    
                    // ç­‰å¾…æ¸¬è©¦å®Œæˆ
                    await new Promise((resolve) => {
                        testUtterance.onend = resolve;
                        testUtterance.onerror = resolve;
                        setTimeout(resolve, 1000); // æœ€å¤šç­‰å¾…1ç§’
                    });
                    
                    console.log('èªéŸ³æ¸¬è©¦å®Œæˆ');
                    
                } catch (error) {
                    console.error('èªéŸ³æ¸¬è©¦å¤±æ•—:', error);
                }
            }
            
            async generateAudioFromBrowserSpeech() {
                try {
                    console.log('æº–å‚™éŸ³é »éŒ„è£½åŠŸèƒ½...');
                    
                    // æª¢æŸ¥ MediaRecorder æ”¯æ´
                    if (!window.MediaRecorder) {
                        console.log('ç€è¦½å™¨ä¸æ”¯æ´ MediaRecorderï¼Œè·³ééŸ³é »éŒ„è£½');
                        return;
                    }
                    
                    // å»ºç«‹éŸ³é »ä¸Šä¸‹æ–‡
                    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    
                    // æª¢æŸ¥æ”¯æ´çš„ MIME é¡å‹
                    let mimeType = 'audio/webm';
                    if (MediaRecorder.isTypeSupported('audio/webm;codecs=opus')) {
                        mimeType = 'audio/webm;codecs=opus';
                    } else if (MediaRecorder.isTypeSupported('audio/mp4')) {
                        mimeType = 'audio/mp4';
                    } else if (MediaRecorder.isTypeSupported('audio/ogg')) {
                        mimeType = 'audio/ogg';
                    }
                    
                    console.log('ä½¿ç”¨ MIME é¡å‹:', mimeType);
                    
                    // å»ºç«‹éœéŸ³éŸ³é »æµç”¨æ–¼éŒ„è£½
                    const destination = audioContext.createMediaStreamDestination();
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(destination);
                    gainNode.gain.value = 0.001; // æ¥µä½éŸ³é‡
                    oscillator.frequency.value = 440;
                    oscillator.start();
                    
                    // å»ºç«‹ MediaRecorder
                    const mediaRecorder = new MediaRecorder(destination.stream, { mimeType });
                    const audioChunks = [];
                    
                    mediaRecorder.ondataavailable = (event) => {
                        if (event.data.size > 0) {
                            audioChunks.push(event.data);
                        }
                    };
                    
                    // é–‹å§‹éŒ„è£½
                    mediaRecorder.start();
                    
                    // æ¨¡æ“¬éŒ„è£½æ™‚é–“ï¼ˆæ ¹æ“šè…³æœ¬é•·åº¦ï¼‰
                    let totalDuration = 0;
                    for (const item of this.speechQueue) {
                        if (item.type === 'speech') {
                            totalDuration += item.text.length * 100; // ä¼°ç®—æœ—è®€æ™‚é–“
                        } else if (item.type === 'pause') {
                            totalDuration += item.duration;
                        }
                    }
                    
                    // æœ€å°‘éŒ„è£½ 2 ç§’
                    totalDuration = Math.max(totalDuration, 2000);
                    
                    console.log('é ä¼°éŒ„è£½æ™‚é–“:', totalDuration, 'ms');
                    
                    // ç­‰å¾…éŒ„è£½æ™‚é–“
                    await new Promise(resolve => setTimeout(resolve, totalDuration));
                    
                    // åœæ­¢éŒ„è£½
                    mediaRecorder.stop();
                    oscillator.stop();
                    
                    // ç­‰å¾…éŒ„è£½å®Œæˆ
                    await new Promise((resolve) => {
                        mediaRecorder.onstop = () => {
                            if (audioChunks.length > 0) {
                                const audioBlob = new Blob(audioChunks, { type: mimeType });
                                this.currentBlob = audioBlob;
                                console.log('éŸ³é »éŒ„è£½å®Œæˆï¼Œæª”æ¡ˆå¤§å°:', audioBlob.size, 'bytes');
                            } else {
                                console.log('éŒ„è£½å¤±æ•—ï¼Œæ²’æœ‰éŸ³é »æ•¸æ“š');
                            }
                            resolve();
                        };
                    });
                    
                    // é—œé–‰éŸ³é »ä¸Šä¸‹æ–‡
                    audioContext.close();
                    
                } catch (error) {
                    console.error('éŸ³é »éŒ„è£½éŒ¯èª¤:', error);
                    // å¦‚æœéŒ„è£½å¤±æ•—ï¼Œä»ç„¶å…è¨±æ’­æ”¾
                    console.log('éŸ³é »éŒ„è£½åŠŸèƒ½ä¸å¯ç”¨ï¼Œä½†èªéŸ³æ’­æ”¾ä»ç„¶å¯ç”¨');
                }
            }
            
            async playBrowserSpeech() {
                return new Promise((resolve, reject) => {
                    console.log('é–‹å§‹æ’­æ”¾èªéŸ³åºåˆ—ï¼Œå…±', this.speechQueue.length, 'å€‹é …ç›®');
                    
                    // ç¢ºä¿èªéŸ³åˆæˆå·²åœæ­¢
                    speechSynthesis.cancel();
                    
                    let currentIndex = 0;
                    let isPlaying = true;
                    
                    const playNext = () => {
                        if (!isPlaying || currentIndex >= this.speechQueue.length) {
                            console.log('èªéŸ³æ’­æ”¾å®Œæˆ');
                            if (this.currentAudio && this.currentAudio.onended) {
                                this.currentAudio.onended();
                            }
                            resolve();
                            return;
                        }
                        
                        const item = this.speechQueue[currentIndex];
                        console.log(`æ’­æ”¾é …ç›® ${currentIndex + 1}:`, item.type, item.type === 'speech' ? item.text : `${item.duration/1000}ç§’`);
                        currentIndex++;
                        
                        if (item.type === 'speech') {
                            // å‰µå»ºæ–°çš„èªéŸ³å¯¦ä¾‹ä»¥é¿å…é‡è¤‡ä½¿ç”¨å•é¡Œ
                            const utterance = new SpeechSynthesisUtterance(item.text);
                            utterance.voice = item.utterance.voice;
                            utterance.lang = item.utterance.lang;
                            utterance.rate = item.utterance.rate;
                            utterance.pitch = item.utterance.pitch;
                            utterance.volume = item.utterance.volume;
                            
                            utterance.onstart = () => {
                                console.log('é–‹å§‹æœ—è®€:', item.text.substring(0, 20) + '...');
                            };
                            
                            utterance.onend = () => {
                                console.log('æœ—è®€å®Œæˆ:', item.text.substring(0, 20) + '...');
                                setTimeout(playNext, 200); // ç¨é•·çš„é–“éš”
                            };
                            
                            utterance.onerror = (error) => {
                                console.error('èªéŸ³æ’­æ”¾éŒ¯èª¤:', error, 'æ–‡å­—:', item.text);
                                // ç™¼ç”ŸéŒ¯èª¤æ™‚ç¹¼çºŒä¸‹ä¸€å€‹ï¼Œè€Œä¸æ˜¯åœæ­¢æ•´å€‹æ’­æ”¾
                                setTimeout(playNext, 100);
                            };
                            
                            // æª¢æŸ¥èªéŸ³åˆæˆæ˜¯å¦å¯ç”¨
                            if (speechSynthesis.paused) {
                                speechSynthesis.resume();
                            }
                            
                            try {
                                speechSynthesis.speak(utterance);
                                console.log('å·²ç™¼é€èªéŸ³æŒ‡ä»¤');
                            } catch (error) {
                                console.error('èªéŸ³æ’­æ”¾å¤±æ•—:', error);
                                setTimeout(playNext, 100);
                            }
                            
                        } else if (item.type === 'pause') {
                            console.log('æš«åœ', item.duration/1000, 'ç§’');
                            setTimeout(playNext, item.duration);
                        }
                    };
                    
                    // è¨­å®šåœæ­¢å‡½æ•¸
                    this.currentAudio.pause = () => {
                        isPlaying = false;
                        speechSynthesis.cancel();
                        console.log('èªéŸ³æ’­æ”¾å·²åœæ­¢');
                    };
                    
                    // é–‹å§‹æ’­æ”¾
                    playNext();
                });
            }
            
            displayResults() {
                this.resultSection.style.display = 'block';
                this.showMessage('èªéŸ³æª”æ¡ˆç”Ÿæˆå®Œæˆï¼æ‚¨å¯ä»¥æ’­æ”¾è©¦è½æˆ–ä¸‹è¼‰æª”æ¡ˆã€‚', 'success');
                this.resultSection.scrollIntoView({ behavior: 'smooth' });
            }
            
            playAudio() {
                if (!this.currentAudio) {
                    this.showMessage('è«‹å…ˆç”ŸæˆèªéŸ³æª”æ¡ˆ', 'error');
                    return;
                }
                
                console.log('æ’­æ”¾æŒ‰éˆ•è¢«é»æ“Šï¼Œæ¨¡å¼:', this.isPremiumMode ? 'é«˜å“è³ª' : 'å…è²»');
                
                this.playBtn.textContent = 'ğŸ”Š æ’­æ”¾ä¸­...';
                this.playBtn.disabled = true;
                
                if (this.isPremiumMode && this.currentAudio.play && typeof this.currentAudio.play === 'function') {
                    // é«˜å“è³ªæ¨¡å¼ï¼šæ’­æ”¾ MP3 æª”æ¡ˆ
                    console.log('æ’­æ”¾ MP3 æª”æ¡ˆ');
                    
                    this.currentAudio.currentTime = 0;
                    
                    const playPromise = this.currentAudio.play();
                    if (playPromise !== undefined) {
                        playPromise.then(() => {
                            console.log('MP3 æ’­æ”¾é–‹å§‹');
                        }).catch(error => {
                            console.error('MP3 æ’­æ”¾å¤±æ•—:', error);
                            this.playBtn.textContent = 'â–¶ï¸ æ’­æ”¾å®Œæ•´èªéŸ³';
                            this.playBtn.disabled = false;
                            this.showMessage('MP3 æ’­æ”¾å¤±æ•—ï¼Œè«‹æª¢æŸ¥éŸ³é »æª”æ¡ˆ', 'error');
                        });
                    }
                    
                    this.currentAudio.onended = () => {
                        console.log('MP3 æ’­æ”¾çµæŸ');
                        this.playBtn.textContent = 'â–¶ï¸ æ’­æ”¾å®Œæ•´èªéŸ³';
                        this.playBtn.disabled = false;
                    };
                    
                    this.currentAudio.onerror = (error) => {
                        console.error('MP3 æ’­æ”¾éŒ¯èª¤:', error);
                        this.playBtn.textContent = 'â–¶ï¸ æ’­æ”¾å®Œæ•´èªéŸ³';
                        this.playBtn.disabled = false;
                        this.showMessage('æ’­æ”¾å¤±æ•—ï¼Œè«‹é‡æ–°ç”ŸæˆèªéŸ³æª”æ¡ˆ', 'error');
                    };
                    
                } else {
                    // å…è²»æ¨¡å¼ï¼šä½¿ç”¨ç€è¦½å™¨èªéŸ³åˆæˆ
                    console.log('ä½¿ç”¨ç€è¦½å™¨èªéŸ³åˆæˆæ’­æ”¾');
                    
                    // æª¢æŸ¥èªéŸ³éšŠåˆ—
                    if (!this.speechQueue || this.speechQueue.length === 0) {
                        console.error('èªéŸ³éšŠåˆ—ç‚ºç©º');
                        this.playBtn.textContent = 'â–¶ï¸ æ’­æ”¾å®Œæ•´èªéŸ³';
                        this.playBtn.disabled = false;
                        this.showMessage('èªéŸ³éšŠåˆ—ç‚ºç©ºï¼Œè«‹é‡æ–°ç”Ÿæˆ', 'error');
                        return;
                    }
                    
                    // è¨­å®šæ’­æ”¾å®Œæˆå›èª¿
                    this.currentAudio.onended = () => {
                        console.log('ç€è¦½å™¨èªéŸ³æ’­æ”¾çµæŸ');
                        this.playBtn.textContent = 'â–¶ï¸ æ’­æ”¾å®Œæ•´èªéŸ³';
                        this.playBtn.disabled = false;
                    };
                    
                    this.currentAudio.onerror = (error) => {
                        console.error('ç€è¦½å™¨èªéŸ³æ’­æ”¾éŒ¯èª¤:', error);
                        this.playBtn.textContent = 'â–¶ï¸ æ’­æ”¾å®Œæ•´èªéŸ³';
                        this.playBtn.disabled = false;
                        this.showMessage('èªéŸ³æ’­æ”¾å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç€è¦½å™¨è¨­å®š', 'error');
                    };
                    
                    // é–‹å§‹æ’­æ”¾
                    this.currentAudio.play().catch(error => {
                        console.error('æ’­æ”¾å•Ÿå‹•å¤±æ•—:', error);
                        this.playBtn.textContent = 'â–¶ï¸ æ’­æ”¾å®Œæ•´èªéŸ³';
                        this.playBtn.disabled = false;
                        this.showMessage(`æ’­æ”¾å¤±æ•—ï¼š${error.message}`, 'error');
                    });
                }
            }
            
            downloadAudio() {
                if (this.currentBlob) {
                    const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
                    let fileName, message;
                    
                    if (this.isPremiumMode) {
                        // é«˜å“è³ªæ¨¡å¼ï¼šä¸‹è¼‰ MP3
                        const isMP3 = this.currentBlob.type === 'audio/mpeg';
                        const extension = isMP3 ? 'mp3' : 'txt';
                        fileName = `èªéŸ³è…³æœ¬_é«˜å“è³ª_${timestamp}.${extension}`;
                        message = isMP3 
                            ? 'ğŸµ é«˜å“è³ª MP3 æª”æ¡ˆä¸‹è¼‰é–‹å§‹ï¼é€™æ˜¯æ‚¨çš„å®Œæ•´èªéŸ³è…³æœ¬æª”æ¡ˆã€‚'
                            : 'ğŸ“„ æ–‡æœ¬æª”æ¡ˆä¸‹è¼‰é–‹å§‹ï¼å¦‚éœ€ MP3 æª”æ¡ˆï¼Œè«‹è¨­å®š Google Cloud API Keyã€‚';
                    } else {
                        // å…è²»æ¨¡å¼ï¼šä¸‹è¼‰éŒ„è£½çš„éŸ³é »æª”æ¡ˆ
                        const isAudio = this.currentBlob.type.startsWith('audio/');
                        if (isAudio) {
                            fileName = `èªéŸ³è…³æœ¬_å…è²»ç‰ˆ_${timestamp}.webm`;
                            message = 'ğŸµ éŸ³é »æª”æ¡ˆä¸‹è¼‰é–‹å§‹ï¼é€™æ˜¯ä½¿ç”¨ç€è¦½å™¨èªéŸ³éŒ„è£½çš„æª”æ¡ˆã€‚';
                        } else {
                            fileName = `èªéŸ³è…³æœ¬_å…è²»ç‰ˆ_${timestamp}.txt`;
                            message = 'ğŸ“„ æ–‡æœ¬æª”æ¡ˆä¸‹è¼‰é–‹å§‹ï¼';
                        }
                    }
                    
                    const url = URL.createObjectURL(this.currentBlob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = fileName;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    this.showMessage(message, 'success');
                    
                } else if (!this.isPremiumMode && this.scriptItems.length > 0) {
                    // å‚™ç”¨æ–¹æ¡ˆï¼šç”Ÿæˆè…³æœ¬æ–‡å­—æª”æ¡ˆ
                    this.generateScriptTextFile();
                } else {
                    this.showMessage('è«‹å…ˆç”ŸæˆèªéŸ³æª”æ¡ˆ', 'error');
                }
            }
            
            generateScriptTextFile() {
                // å»ºç«‹è©³ç´°çš„è…³æœ¬å…§å®¹
                let scriptContent = 'ğŸ¯ è‹±æ–‡å£èªªå‡ºé¡Œç³»çµ± - èªéŸ³è…³æœ¬\n';
                scriptContent += '=' .repeat(50) + '\n\n';
                scriptContent += `ç”Ÿæˆæ™‚é–“ï¼š${new Date().toLocaleString('zh-TW')}\n`;
                scriptContent += `æ¨¡å¼ï¼šå…è²»æ¨¡å¼ (ç€è¦½å™¨å…§å»ºèªéŸ³)\n`;
                scriptContent += `è…³æœ¬é …ç›®æ•¸é‡ï¼š${this.scriptItems.length}\n\n`;
                
                scriptContent += 'ğŸ“ å®Œæ•´è…³æœ¬å…§å®¹ï¼š\n';
                scriptContent += '-'.repeat(30) + '\n\n';
                
                let itemNumber = 1;
                for (const item of this.scriptItems) {
                    if (item.type === 'text') {
                        scriptContent += `${itemNumber}. ğŸ“¢ æ–‡å­—æœ—è®€\n`;
                        scriptContent += `   å…§å®¹ï¼š${item.text}\n`;
                        scriptContent += `   èªéŸ³ï¼š${item.voice}\n\n`;
                        itemNumber++;
                    } else if (item.type === 'pause') {
                        scriptContent += `${itemNumber}. â¸ï¸ æš«åœæ™‚é–“\n`;
                        scriptContent += `   æ™‚é•·ï¼š${item.duration} ç§’\n\n`;
                        itemNumber++;
                    }
                }
                
                scriptContent += '\n' + '='.repeat(50) + '\n';
                scriptContent += 'ğŸ’¡ ä½¿ç”¨èªªæ˜ï¼š\n';
                scriptContent += 'â€¢ æ­¤æª”æ¡ˆåŒ…å«å®Œæ•´çš„èªéŸ³è…³æœ¬å…§å®¹\n';
                scriptContent += 'â€¢ å…è²»æ¨¡å¼ä½¿ç”¨ç€è¦½å™¨å…§å»ºèªéŸ³å¼•æ“\n';
                scriptContent += 'â€¢ å¦‚éœ€é«˜å“è³ª MP3 æª”æ¡ˆï¼Œè«‹åˆ‡æ›åˆ°é«˜å“è³ªæ¨¡å¼\n';
                scriptContent += 'â€¢ å¯å°‡æ­¤è…³æœ¬åŒ¯å…¥å…¶ä»–èªéŸ³åˆæˆè»Ÿé«”ä½¿ç”¨\n\n';
                
                scriptContent += 'ğŸ”— ç›¸é—œé€£çµï¼š\n';
                scriptContent += 'â€¢ Google Cloud Text-to-Speech: https://cloud.google.com/text-to-speech\n';
                scriptContent += 'â€¢ Microsoft Speech Platform: https://www.microsoft.com/cognitive-services/speech\n';
                scriptContent += 'â€¢ Amazon Polly: https://aws.amazon.com/polly/\n\n';
                
                scriptContent += `æª”æ¡ˆç”Ÿæˆæ–¼ï¼š${new Date().toISOString()}\n`;
                
                // å»ºç«‹ä¸¦ä¸‹è¼‰æª”æ¡ˆ
                const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
                const fileName = `èªéŸ³è…³æœ¬_å…è²»ç‰ˆ_${timestamp}.txt`;
                
                const blob = new Blob([scriptContent], { type: 'text/plain;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = fileName;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                this.showMessage(`
                    ğŸ“„ <strong>è…³æœ¬æ–‡å­—æª”æ¡ˆä¸‹è¼‰å®Œæˆï¼</strong><br><br>
                    âœ… æª”æ¡ˆåŒ…å«å®Œæ•´çš„èªéŸ³è…³æœ¬å…§å®¹<br>
                    âœ… å¯åŒ¯å…¥å…¶ä»–èªéŸ³åˆæˆè»Ÿé«”ä½¿ç”¨<br>
                    âœ… åŒ…å«è©³ç´°çš„è¨­å®šåƒæ•¸å’Œä½¿ç”¨èªªæ˜<br><br>
                    ğŸ’¡ <strong>æç¤ºï¼š</strong>å¦‚éœ€çœŸæ­£çš„ MP3 éŸ³é »æª”æ¡ˆï¼Œè«‹åˆ‡æ›åˆ°é«˜å“è³ªæ¨¡å¼ä¸¦è¨­å®š Google Cloud API Key
                `, 'success');
            }
            
            showMessage(message, type) {
                this.statusMessage.innerHTML = `<div class="${type}">${message}</div>`;
                
                // API è¨­å®šéŒ¯èª¤è¨Šæ¯ä¸è‡ªå‹•æ¶ˆå¤±ï¼Œå…¶ä»–è¨Šæ¯ 8 ç§’å¾Œæ¶ˆå¤±
                if (type === 'success' || (type === 'error' && !message.includes('API å°šæœªå•Ÿç”¨'))) {
                    setTimeout(() => {
                        this.statusMessage.innerHTML = '';
                    }, 8000);
                }
            }
        }
        
        // å…¨åŸŸè®Šæ•¸ä¾› HTML äº‹ä»¶ä½¿ç”¨
        let generator;
        
        // é é¢è¼‰å…¥å®Œæˆå¾Œåˆå§‹åŒ–
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                generator = new ScriptBasedSpeechGenerator();
            });
        } else {
            generator = new ScriptBasedSpeechGenerator();
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'994f4cc2e16e8448',t:'MTc2MTUzNzc2Ny4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
