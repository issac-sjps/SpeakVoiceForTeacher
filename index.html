<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ëã±ÊñáÂè£Ë™™Âá∫È°åÁ≥ªÁµ±</title>
    <style>
        body {
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100%;
        }
        
        html {
            height: 100%;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100%;
        }
        
        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }
        
        .card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 20px;
        }
        
        .form-group {
            margin-bottom: 25px;
        }
        
        label {
            display: block;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
            font-size: 1.1rem;
        }
        
        textarea, input[type="text"], input[type="password"] {
            width: 100%;
            padding: 15px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            font-size: 16px;
            font-family: inherit;
            resize: vertical;
            transition: border-color 0.3s ease;
            box-sizing: border-box;
        }
        
        textarea:focus, input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 1.1rem;
            font-weight: 600;
            border-radius: 10px;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            width: 100%;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .mode-selector {
            margin-bottom: 30px;
        }
        
        .mode-buttons {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .mode-btn {
            flex: 1;
            padding: 15px 20px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            background: white;
            color: #495057;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .mode-btn:hover {
            border-color: #667eea;
            color: #667eea;
        }
        
        .mode-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
        }
        
        .api-setup {
            display: none;
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-top: 15px;
        }
        
        .api-setup.show {
            display: block;
        }
        
        .script-editor {
            margin-top: 20px;
        }
        
        .script-item {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            position: relative;
            cursor: move;
            transition: all 0.3s ease;
            padding-left: 50px;
        }
        
        .script-item:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }
        
        .script-item.dragging {
            opacity: 0.5;
            transform: rotate(5deg);
            z-index: 1000;
        }
        
        .script-item.drag-over {
            border-color: #667eea;
            background: #f0f4ff;
        }
        
        .script-item.text-item {
            border-left: 4px solid #28a745;
        }
        
        .script-item.pause-item {
            border-left: 4px solid #ffc107;
            background: #fff8e1;
        }
        
        .drag-handle {
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: #6c757d;
            font-size: 18px;
            cursor: grab;
            user-select: none;
        }
        
        .drag-handle:active {
            cursor: grabbing;
        }
        
        .item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .item-type {
            font-weight: 600;
            color: #495057;
        }
        
        .delete-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .delete-btn:hover {
            background: #c82333;
        }
        
        .text-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
            margin-bottom: 15px;
            resize: vertical;
            box-sizing: border-box;
        }
        
        .voice-select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 14px;
            box-sizing: border-box;
        }
        
        .pause-controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .pause-slider {
            flex: 1;
        }
        
        .pause-value {
            font-weight: 600;
            color: #ffc107;
            min-width: 60px;
        }
        
        .add-buttons {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .add-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s ease;
        }
        
        .add-btn:hover {
            background: #5a6268;
        }
        
        .text-btn {
            background: #28a745;
        }
        
        .text-btn:hover {
            background: #218838;
        }
        
        .pause-btn {
            background: #ffc107;
            color: #212529;
        }
        
        .pause-btn:hover {
            background: #e0a800;
        }
        
        .empty-state {
            text-align: center;
            color: #6c757d;
            padding: 40px;
            border: 2px dashed #dee2e6;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .result-section {
            display: none;
        }
        
        .audio-player {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            margin-bottom: 20px;
        }
        
        .play-btn, .download-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            margin: 0 10px;
            transition: background-color 0.3s ease;
        }
        
        .play-btn:hover {
            background: #218838;
        }
        
        .download-btn {
            background: #007bff;
        }
        
        .download-btn:hover {
            background: #0056b3;
        }
        
        .message {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }
        
        .message.success {
            background: #d4edda;
            color: #155724;
            border-left: 4px solid #28a745;
        }
        
        .message.error {
            background: #f8d7da;
            color: #721c24;
            border-left: 4px solid #dc3545;
        }
        
        .message.loading {
            background: #d1ecf1;
            color: #0c5460;
            border-left: 4px solid #17a2b8;
        }
        
        .info-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            border-left: 4px solid #28a745;
            margin-top: 15px;
        }
        
        .info-card h4 {
            margin: 0 0 15px 0;
            color: #333;
        }
        
        .info-card ul {
            margin: 0;
            padding-left: 20px;
        }
        
        .info-card li {
            margin-bottom: 8px;
            color: #555;
        }
        
        .premium-info {
            border-left-color: #ffc107;
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>üéØ Ëã±ÊñáÂè£Ë™™Âá∫È°åÁ≥ªÁµ±</h1>
            <p>Ëº∏ÂÖ•Ëã±ÊñáÂíå‰∏≠ÊñáÂéüÊñáÔºåÁîüÊàêÈÅìÂú∞ÁæéÂºèÁôºÈü≥ÁöÑMP3Ê™îÊ°à</p>
        </header>
        
        <main>
            <div class="card">
                <div class="mode-selector">
                    <h3>üéµ Ë™ûÈü≥Ê®°ÂºèÈÅ∏Êìá</h3>
                    <div class="mode-buttons">
                        <button class="mode-btn active" data-mode="free">
                            üÜì ÂÖçË≤ªÊ®°Âºè (ÁÄèË¶ΩÂô®ÂÖßÂª∫)
                        </button>
                        <button class="mode-btn" data-mode="premium">
                            ‚≠ê È´òÂìÅË≥™Ê®°Âºè (ÈúÄË¶Å API Key)
                        </button>
                    </div>
                    
                    <div class="api-setup" id="apiSetup">
                        <div class="form-group">
                            <label for="apiKey">Google Cloud Text-to-Speech API KeyÔºö</label>
                            <input 
                                type="password" 
                                id="apiKey" 
                                placeholder="Ë´ãËº∏ÂÖ•ÊÇ®ÁöÑ Google Cloud API Key"
                            >
                            <small style="color: #666; display: block; margin-top: 5px;">
                                <strong>üìã Ë®≠ÂÆöÊ≠•È©üÔºö</strong><br>
                                1. Âà∞ <a href="https://console.cloud.google.com/" target="_blank" rel="noopener noreferrer">Google Cloud Console</a> Âª∫Á´ãÂ∞àÊ°à<br>
                                2. ÂïüÁî® <a href="https://console.cloud.google.com/apis/library/texttospeech.googleapis.com" target="_blank" rel="noopener noreferrer">Text-to-Speech API</a><br>
                                3. Âà∞ <a href="https://console.cloud.google.com/apis/credentials" target="_blank" rel="noopener noreferrer">ÊÜëË≠âÈ†ÅÈù¢</a> ÈªûÊìä„ÄåÂª∫Á´ãÊÜëË≠â„Äç<br>
                                4. <strong>‚ö†Ô∏è ÈáçË¶ÅÔºöÈÅ∏Êìá„ÄåAPI ÈáëÈë∞„Äç(‰∏çÊòØ OAuth 2.0 Áî®Êà∂Á´Ø ID)</strong><br>
                                5. Ë§áË£ΩÁî¢ÁîüÁöÑ API Key ‰∏¶Ë≤ºÂà∞‰∏äÊñπËº∏ÂÖ•Ê°Ü
                            </small>
                        </div>
                    </div>
                    
                    <div class="info-card" id="modeInfo">
                        <h4>üÜì ÂÖçË≤ªÊ®°ÂºèÁâπËâ≤</h4>
                        <ul>
                            <li>‚úÖ ÂÆåÂÖ®ÂÖçË≤ªÔºåÁÑ°ÈúÄË®ªÂÜä</li>
                            <li>‚úÖ ÊîØÊè¥Â§öÁ®ÆË™ûÈü≥ÈÅ∏È†Ö</li>
                            <li>‚úÖ Âç≥ÊôÇÁîüÊàêÔºåÁÑ°ÈúÄÁ≠âÂæÖ</li>
                            <li>‚úÖ ÂèØ‰∏ãËºâÈü≥È†ªÊ™îÊ°à</li>
                            <li>‚ö†Ô∏è Èü≥Ë≥™ËºÉÂü∫Êú¨</li>
                            <li>‚ö†Ô∏è Èü≥È†ªÊ†ºÂºèÁÇ∫ WebM (Èùû MP3)</li>
                        </ul>
                    </div>
                </div>
                
                <div class="script-editor">
                    <h3>üìù Ë™ûÈü≥ËÖ≥Êú¨Á∑®ËºØÂô®</h3>
                    <div id="scriptItems">
                        <div class="empty-state">
                            <h4>üìù ÈñãÂßãÂª∫Á´ãÊÇ®ÁöÑË™ûÈü≥ËÖ≥Êú¨</h4>
                            <p>ÈªûÊìä‰∏ãÊñπÊåâÈàïÊñ∞Â¢ûÊñáÂ≠óÊÆµËêΩÊàñÊö´ÂÅúÊôÇÈñì</p>
                        </div>
                    </div>
                    
                    <div class="add-buttons">
                        <button class="add-btn text-btn" id="addTextBtn">
                            ‚ûï Êñ∞Â¢ûÊñáÂ≠óÊÆµËêΩ
                        </button>
                        <button class="add-btn pause-btn" id="addPauseBtn">
                            ‚è∏Ô∏è Êñ∞Â¢ûÊö´ÂÅú
                        </button>
                    </div>
                    
                    <button class="btn" id="generateBtn">
                        üéµ ÁîüÊàêÂÆåÊï¥Ë™ûÈü≥Ê™îÊ°à
                    </button>
                </div>
            </div>
            
            <div class="card result-section" id="resultSection">
                <h3>üéµ Ë™ûÈü≥Ê™îÊ°àÂ∑≤ÁîüÊàê</h3>
                
                <div class="audio-player">
                    <p>ÊÇ®ÁöÑË™ûÈü≥ËÖ≥Êú¨Â∑≤ÊàêÂäüÁîüÊàêÔºö</p>
                    <button class="play-btn" id="playBtn">‚ñ∂Ô∏è Êí≠ÊîæÂÆåÊï¥Ë™ûÈü≥</button>
                    <button class="download-btn" id="downloadBtn">‚¨áÔ∏è ‰∏ãËºâÊ™îÊ°à</button>
                </div>
                
                <div id="statusMessage"></div>
            </div>
        </main>
    </div>

    <script>
        class SpeechGenerator {
            constructor() {
                this.currentMode = 'free';
                this.apiKey = '';
                this.scriptItems = [];
                this.itemCounter = 0;
                this.currentAudio = null;
                this.currentBlob = null;
                this.speechQueue = [];
                
                this.init();
            }
            
            init() {
                this.bindEvents();
                this.loadSavedData();
                this.updateModeDisplay();
            }
            
            bindEvents() {
                // Ê®°ÂºèÂàáÊèõÊåâÈàï
                document.querySelectorAll('.mode-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const mode = e.target.dataset.mode;
                        this.switchMode(mode);
                    });
                });
                
                // API Key Ëº∏ÂÖ•
                document.getElementById('apiKey').addEventListener('input', (e) => {
                    this.apiKey = e.target.value.trim();
                    this.saveApiKey();
                });
                
                // ËÖ≥Êú¨Á∑®ËºØÊåâÈàï
                document.getElementById('addTextBtn').addEventListener('click', () => {
                    this.addTextItem();
                });
                
                document.getElementById('addPauseBtn').addEventListener('click', () => {
                    this.addPauseItem();
                });
                
                // ÁîüÊàêÂíåÊí≠ÊîæÊåâÈàï
                document.getElementById('generateBtn').addEventListener('click', () => {
                    this.generateSpeech();
                });
                
                document.getElementById('playBtn').addEventListener('click', () => {
                    this.playAudio();
                });
                
                document.getElementById('downloadBtn').addEventListener('click', () => {
                    this.downloadAudio();
                });
            }
            
            switchMode(mode) {
                this.currentMode = mode;
                
                // Êõ¥Êñ∞ÊåâÈàïÁãÄÊÖã
                document.querySelectorAll('.mode-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                document.querySelector(`[data-mode="${mode}"]`).classList.add('active');
                
                // È°ØÁ§∫/Èö±Ëóè API Ë®≠ÂÆö
                const apiSetup = document.getElementById('apiSetup');
                if (mode === 'premium') {
                    apiSetup.classList.add('show');
                } else {
                    apiSetup.classList.remove('show');
                }
                
                this.updateModeDisplay();
                this.renderScriptItems();
                
                console.log('ÂàáÊèõÂà∞Ê®°Âºè:', mode);
            }
            
            updateModeDisplay() {
                const modeInfo = document.getElementById('modeInfo');
                
                if (this.currentMode === 'premium') {
                    modeInfo.innerHTML = `
                        <h4>‚≠ê È´òÂìÅË≥™Ê®°ÂºèÁâπËâ≤</h4>
                        <ul>
                            <li>‚úÖ Â∞àÊ•≠Á¥öË™ûÈü≥ÂìÅË≥™</li>
                            <li>‚úÖ Â§öÁ®ÆËá™ÁÑ∂Ë™ûÈü≥ÈÅ∏È†Ö</li>
                            <li>‚úÖ ÂèØ‰∏ãËºâÈ´òÂìÅË≥™ MP3</li>
                            <li>‚úÖ ÊîØÊè¥Ë™ûÈü≥ÂèÉÊï∏Ë™øÊï¥</li>
                            <li>‚ö†Ô∏è ÈúÄË¶Å Google Cloud API Key</li>
                        </ul>
                    `;
                    modeInfo.className = 'info-card premium-info';
                } else {
                    modeInfo.innerHTML = `
                        <h4>üÜì ÂÖçË≤ªÊ®°ÂºèÁâπËâ≤</h4>
                        <ul>
                            <li>‚úÖ ÂÆåÂÖ®ÂÖçË≤ªÔºåÁÑ°ÈúÄË®ªÂÜä</li>
                            <li>‚úÖ ÊîØÊè¥Â§öÁ®ÆË™ûÈü≥ÈÅ∏È†Ö</li>
                            <li>‚úÖ Âç≥ÊôÇÁîüÊàêÔºåÁÑ°ÈúÄÁ≠âÂæÖ</li>
                            <li>‚úÖ ÂèØ‰∏ãËºâÈü≥È†ªÊ™îÊ°à</li>
                            <li>‚ö†Ô∏è Èü≥Ë≥™ËºÉÂü∫Êú¨</li>
                            <li>‚ö†Ô∏è Èü≥È†ªÊ†ºÂºèÁÇ∫ WebM (Èùû MP3)</li>
                        </ul>
                    `;
                    modeInfo.className = 'info-card';
                }
            }
            
            loadSavedData() {
                // ËºâÂÖ• API Key
                const savedKey = localStorage.getItem('speechApiKey');
                if (savedKey) {
                    this.apiKey = savedKey;
                    document.getElementById('apiKey').value = savedKey;
                }
                
                // ËºâÂÖ•ËÖ≥Êú¨
                const savedScript = localStorage.getItem('speechScript');
                if (savedScript) {
                    try {
                        this.scriptItems = JSON.parse(savedScript);
                        this.itemCounter = Math.max(...this.scriptItems.map(item => item.id), 0);
                        this.renderScriptItems();
                    } catch (error) {
                        console.error('ËºâÂÖ•ËÖ≥Êú¨Â§±Êïó:', error);
                    }
                }
            }
            
            saveApiKey() {
                if (this.apiKey) {
                    localStorage.setItem('speechApiKey', this.apiKey);
                } else {
                    localStorage.removeItem('speechApiKey');
                }
            }
            
            saveScript() {
                localStorage.setItem('speechScript', JSON.stringify(this.scriptItems));
            }
            
            addTextItem() {
                const item = {
                    id: ++this.itemCounter,
                    type: 'text',
                    text: '',
                    voice: this.getDefaultVoice()
                };
                
                this.scriptItems.push(item);
                this.renderScriptItems();
                this.saveScript();
            }
            
            addPauseItem() {
                const item = {
                    id: ++this.itemCounter,
                    type: 'pause',
                    duration: 2.0
                };
                
                this.scriptItems.push(item);
                this.renderScriptItems();
                this.saveScript();
            }
            
            getDefaultVoice() {
                return this.currentMode === 'premium' ? 'en-US-Journey-D' : 'native';
            }
            
            getVoiceOptions(selectedVoice) {
                if (this.currentMode === 'premium') {
                    return `
                        <optgroup label="üá∫üá∏ Ëã±Ë™ûË™ûÈü≥">
                            <option value="en-US-Journey-D" ${selectedVoice === 'en-US-Journey-D' ? 'selected' : ''}>ÁæéÂºèËã±Ë™û (Â•≥ÊÄß) - Journey</option>
                            <option value="en-US-Journey-F" ${selectedVoice === 'en-US-Journey-F' ? 'selected' : ''}>ÁæéÂºèËã±Ë™û (Áî∑ÊÄß) - Journey</option>
                            <option value="en-US-Studio-O" ${selectedVoice === 'en-US-Studio-O' ? 'selected' : ''}>ÁæéÂºèËã±Ë™û (Â•≥ÊÄß) - Studio</option>
                            <option value="en-US-Studio-Q" ${selectedVoice === 'en-US-Studio-Q' ? 'selected' : ''}>ÁæéÂºèËã±Ë™û (Áî∑ÊÄß) - Studio</option>
                        </optgroup>
                        <optgroup label="üáπüáº Âè∞ÁÅ£‰∏≠Êñá">
                            <option value="cmn-TW-Standard-A" ${selectedVoice === 'cmn-TW-Standard-A' ? 'selected' : ''}>Âè∞ÁÅ£ÂúãË™û (Â•≥ÊÄß)</option>
                            <option value="cmn-TW-Standard-B" ${selectedVoice === 'cmn-TW-Standard-B' ? 'selected' : ''}>Âè∞ÁÅ£ÂúãË™û (Áî∑ÊÄß)</option>
                        </optgroup>
                    `;
                } else {
                    return `
                        <optgroup label="üá∫üá∏ Ëã±Ë™ûË™ûÈü≥">
                            <option value="native" ${selectedVoice === 'native' ? 'selected' : ''}>Á≥ªÁµ±È†êË®≠Ëã±Ë™û</option>
                            <option value="en-US-female" ${selectedVoice === 'en-US-female' ? 'selected' : ''}>ÁæéÂºèËã±Ë™û (Â•≥ÊÄß)</option>
                            <option value="en-US-male" ${selectedVoice === 'en-US-male' ? 'selected' : ''}>ÁæéÂºèËã±Ë™û (Áî∑ÊÄß)</option>
                        </optgroup>
                        <optgroup label="üáπüáº ‰∏≠ÊñáË™ûÈü≥">
                            <option value="zh-TW-female" ${selectedVoice === 'zh-TW-female' ? 'selected' : ''}>Âè∞ÁÅ£‰∏≠Êñá (Â•≥ÊÄß)</option>
                            <option value="zh-TW-male" ${selectedVoice === 'zh-TW-male' ? 'selected' : ''}>Âè∞ÁÅ£‰∏≠Êñá (Áî∑ÊÄß)</option>
                        </optgroup>
                    `;
                }
            }
            
            renderScriptItems() {
                const container = document.getElementById('scriptItems');
                
                if (this.scriptItems.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <h4>üìù ÈñãÂßãÂª∫Á´ãÊÇ®ÁöÑË™ûÈü≥ËÖ≥Êú¨</h4>
                            <p>ÈªûÊìä‰∏ãÊñπÊåâÈàïÊñ∞Â¢ûÊñáÂ≠óÊÆµËêΩÊàñÊö´ÂÅúÊôÇÈñì</p>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = this.scriptItems.map(item => {
                    if (item.type === 'text') {
                        return `
                            <div class="script-item text-item" data-id="${item.id}" draggable="true">
                                <div class="drag-handle">‚ãÆ‚ãÆ</div>
                                <div class="item-header">
                                    <span class="item-type">üó£Ô∏è ÊñáÂ≠óÊÆµËêΩ</span>
                                    <button class="delete-btn" onclick="speechGen.deleteItem(${item.id})">Âà™Èô§</button>
                                </div>
                                <textarea 
                                    class="text-input" 
                                    placeholder="Ë´ãËº∏ÂÖ•Ë¶ÅÊúóËÆÄÁöÑÊñáÂ≠ó..."
                                    rows="3"
                                    onchange="speechGen.updateItemText(${item.id}, this.value)"
                                >${item.text}</textarea>
                                <select 
                                    class="voice-select" 
                                    onchange="speechGen.updateItemVoice(${item.id}, this.value)"
                                >
                                    ${this.getVoiceOptions(item.voice)}
                                </select>
                            </div>
                        `;
                    } else {
                        return `
                            <div class="script-item pause-item" data-id="${item.id}" draggable="true">
                                <div class="drag-handle">‚ãÆ‚ãÆ</div>
                                <div class="item-header">
                                    <span class="item-type">‚è∏Ô∏è Êö´ÂÅúÊôÇÈñì</span>
                                    <button class="delete-btn" onclick="speechGen.deleteItem(${item.id})">Âà™Èô§</button>
                                </div>
                                <div class="pause-controls">
                                    <input 
                                        type="range" 
                                        class="pause-slider" 
                                        min="0.5" 
                                        max="10" 
                                        step="0.5" 
                                        value="${item.duration}"
                                        oninput="speechGen.updatePauseDuration(${item.id}, this.value)"
                                    >
                                    <span class="pause-value">${item.duration.toFixed(1)} Áßí</span>
                                </div>
                            </div>
                        `;
                    }
                }).join('');
                
                // Á∂ÅÂÆöÊãñÊãΩ‰∫ã‰ª∂
                this.bindDragEvents();
            }
            
            bindDragEvents() {
                const scriptItems = document.querySelectorAll('.script-item');
                scriptItems.forEach(item => {
                    item.addEventListener('dragstart', (e) => this.handleDragStart(e));
                    item.addEventListener('dragover', (e) => this.handleDragOver(e));
                    item.addEventListener('drop', (e) => this.handleDrop(e));
                    item.addEventListener('dragend', (e) => this.handleDragEnd(e));
                    item.addEventListener('dragenter', (e) => this.handleDragEnter(e));
                    item.addEventListener('dragleave', (e) => this.handleDragLeave(e));
                });
            }
            
            handleDragStart(e) {
                this.draggedItemId = parseInt(e.target.dataset.id);
                e.target.classList.add('dragging');
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setData('text/html', e.target.outerHTML);
            }
            
            handleDragOver(e) {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
            }
            
            handleDragEnter(e) {
                e.preventDefault();
                if (e.target.classList.contains('script-item') && 
                    parseInt(e.target.dataset.id) !== this.draggedItemId) {
                    e.target.classList.add('drag-over');
                }
            }
            
            handleDragLeave(e) {
                if (e.target.classList.contains('script-item')) {
                    e.target.classList.remove('drag-over');
                }
            }
            
            handleDrop(e) {
                e.preventDefault();
                const targetElement = e.target.closest('.script-item');
                if (!targetElement) return;
                
                const targetId = parseInt(targetElement.dataset.id);
                
                if (targetId && targetId !== this.draggedItemId) {
                    this.reorderItems(this.draggedItemId, targetId);
                }
                
                // Ê∏ÖÈô§ÊâÄÊúâÊãñÊãΩÊ®£Âºè
                document.querySelectorAll('.script-item').forEach(item => {
                    item.classList.remove('drag-over');
                });
            }
            
            handleDragEnd(e) {
                e.target.classList.remove('dragging');
                this.draggedItemId = null;
                
                // Ê∏ÖÈô§ÊâÄÊúâÊãñÊãΩÊ®£Âºè
                document.querySelectorAll('.script-item').forEach(item => {
                    item.classList.remove('drag-over', 'dragging');
                });
            }
            
            reorderItems(draggedId, targetId) {
                const draggedIndex = this.scriptItems.findIndex(item => item.id === draggedId);
                const targetIndex = this.scriptItems.findIndex(item => item.id === targetId);
                
                if (draggedIndex === -1 || targetIndex === -1) return;
                
                // ÁßªÈô§Ë¢´ÊãñÊãΩÁöÑÈ†ÖÁõÆ
                const draggedItem = this.scriptItems.splice(draggedIndex, 1)[0];
                
                // ÊèíÂÖ•Âà∞ÁõÆÊ®ô‰ΩçÁΩÆ
                this.scriptItems.splice(targetIndex, 0, draggedItem);
                
                // ÈáçÊñ∞Ê∏≤Êüì
                this.renderScriptItems();
                this.saveScript();
                
                // È°ØÁ§∫ÊàêÂäüË®äÊÅØ
                this.showMessage('‚úÖ ÊÆµËêΩÈ†ÜÂ∫èÂ∑≤Êõ¥Êñ∞ÔºÅ', 'success');
            }
            
            updateItemText(itemId, text) {
                const item = this.scriptItems.find(i => i.id === itemId);
                if (item) {
                    item.text = text;
                    this.saveScript();
                }
            }
            
            updateItemVoice(itemId, voice) {
                const item = this.scriptItems.find(i => i.id === itemId);
                if (item) {
                    item.voice = voice;
                    this.saveScript();
                }
            }
            
            updatePauseDuration(itemId, duration) {
                const item = this.scriptItems.find(i => i.id === itemId);
                if (item) {
                    item.duration = parseFloat(duration);
                    const pauseValue = document.querySelector(`[onclick*="${itemId}"] .pause-value`);
                    if (pauseValue) {
                        pauseValue.textContent = `${parseFloat(duration).toFixed(1)} Áßí`;
                    }
                    this.saveScript();
                }
            }
            
            deleteItem(itemId) {
                this.scriptItems = this.scriptItems.filter(item => item.id !== itemId);
                this.renderScriptItems();
                this.saveScript();
            }
            
            async generateSpeech() {
                if (this.scriptItems.length === 0) {
                    this.showMessage('Ë´ãÂÖàÊñ∞Â¢û‰∏Ä‰∫õÊñáÂ≠óÊÆµËêΩ', 'error');
                    return;
                }
                
                const hasText = this.scriptItems.some(item => item.type === 'text' && item.text.trim());
                if (!hasText) {
                    this.showMessage('Ë´ãËá≥Â∞ëÊñ∞Â¢û‰∏ÄÂÄãÂåÖÂê´ÊñáÂ≠óÁöÑÊÆµËêΩ', 'error');
                    return;
                }
                
                if (this.currentMode === 'premium' && !this.apiKey) {
                    this.showMessage('È´òÂìÅË≥™Ê®°ÂºèÈúÄË¶Å Google Cloud API Key', 'error');
                    return;
                }
                
                const generateBtn = document.getElementById('generateBtn');
                generateBtn.disabled = true;
                generateBtn.textContent = 'üîÑ ÁîüÊàê‰∏≠...';
                
                try {
                    if (this.currentMode === 'premium') {
                        await this.generateWithAPI();
                    } else {
                        await this.generateWithBrowser();
                    }
                    
                    this.showResults();
                    this.showMessage('Ë™ûÈü≥Ê™îÊ°àÁîüÊàêÂÆåÊàêÔºÅ', 'success');
                    
                } catch (error) {
                    console.error('ÁîüÊàêÂ§±Êïó:', error);
                    this.showMessage(`ÁîüÊàêÂ§±ÊïóÔºö${error.message}`, 'error');
                } finally {
                    generateBtn.disabled = false;
                    generateBtn.textContent = 'üéµ ÁîüÊàêÂÆåÊï¥Ë™ûÈü≥Ê™îÊ°à';
                }
            }
            
            async generateWithAPI() {
                console.log('‰ΩøÁî® Google API ÁîüÊàêË™ûÈü≥');
                
                const audioSegments = [];
                
                for (const item of this.scriptItems) {
                    if (item.type === 'text' && item.text.trim()) {
                        const languageCode = item.voice.startsWith('en-') ? 'en-US' : 'cmn-TW';
                        
                        const response = await fetch(`https://texttospeech.googleapis.com/v1/text:synthesize?key=${this.apiKey}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                input: { text: item.text.trim() },
                                voice: { languageCode, name: item.voice },
                                audioConfig: { audioEncoding: 'MP3' }
                            })
                        });
                        
                        if (!response.ok) {
                            const error = await response.json();
                            throw new Error(error.error?.message || 'API Ë´ãÊ±ÇÂ§±Êïó');
                        }
                        
                        const data = await response.json();
                        const audioBytes = atob(data.audioContent);
                        const audioArray = new Uint8Array(audioBytes.length);
                        for (let i = 0; i < audioBytes.length; i++) {
                            audioArray[i] = audioBytes.charCodeAt(i);
                        }
                        
                        audioSegments.push(audioArray);
                    }
                }
                
                // Á∞°ÂñÆÂêà‰ΩµÈü≥È†ª
                const totalSize = audioSegments.reduce((sum, segment) => sum + segment.length, 0);
                const mergedArray = new Uint8Array(totalSize);
                let offset = 0;
                
                for (const segment of audioSegments) {
                    mergedArray.set(segment, offset);
                    offset += segment.length;
                }
                
                this.currentBlob = new Blob([mergedArray], { type: 'audio/mpeg' });
                this.currentAudio = new Audio(URL.createObjectURL(this.currentBlob));
            }
            
            async generateWithBrowser() {
                console.log('‰ΩøÁî®ÁÄèË¶ΩÂô®Ë™ûÈü≥ÂêàÊàê');
                
                if (!('speechSynthesis' in window)) {
                    throw new Error('ÁÄèË¶ΩÂô®‰∏çÊîØÊè¥Ë™ûÈü≥ÂêàÊàê');
                }
                
                // Á≠âÂæÖË™ûÈü≥ËºâÂÖ•
                await this.waitForVoices();
                
                this.speechQueue = [];
                
                for (const item of this.scriptItems) {
                    if (item.type === 'text' && item.text.trim()) {
                        const utterance = new SpeechSynthesisUtterance(item.text.trim());
                        utterance.rate = 0.9;
                        utterance.pitch = 1.0;
                        utterance.volume = 1.0;
                        
                        // Ë®≠ÂÆöË™ûÈü≥
                        const voices = speechSynthesis.getVoices();
                        if (item.voice !== 'native' && voices.length > 0) {
                            const selectedVoice = this.findBestVoice(voices, item.voice);
                            if (selectedVoice) {
                                utterance.voice = selectedVoice;
                                utterance.lang = selectedVoice.lang;
                            }
                        }
                        
                        this.speechQueue.push({ type: 'speech', utterance, text: item.text.trim() });
                        
                    } else if (item.type === 'pause') {
                        this.speechQueue.push({ type: 'pause', duration: item.duration * 1000 });
                    }
                }
                
                // Âª∫Á´ãÊí≠ÊîæÊéßÂà∂
                this.currentAudio = {
                    play: () => this.playBrowserSpeech(),
                    pause: () => speechSynthesis.cancel()
                };
                
                // ÁîüÊàêÊñáÂ≠óÊ™îÊ°à‰ΩúÁÇ∫‰∏ãËºâÂÖßÂÆπ
                this.generateTextFile();
            }
            
            waitForVoices() {
                return new Promise((resolve) => {
                    const voices = speechSynthesis.getVoices();
                    if (voices.length > 0) {
                        resolve();
                        return;
                    }
                    
                    speechSynthesis.addEventListener('voiceschanged', resolve, { once: true });
                    setTimeout(resolve, 1000); // Ë∂ÖÊôÇ‰øùË≠∑
                });
            }
            
            findBestVoice(voices, voiceId) {
                if (voiceId.includes('en-US') || voiceId.includes('female') || voiceId.includes('male')) {
                    return voices.find(v => v.lang.startsWith('en-US') || v.lang.startsWith('en')) || voices[0];
                } else if (voiceId.includes('zh-TW')) {
                    return voices.find(v => v.lang.includes('zh-TW') || v.lang.includes('zh')) || voices[0];
                }
                return voices[0];
            }
            
            async playBrowserSpeech() {
                return new Promise((resolve) => {
                    speechSynthesis.cancel();
                    
                    let currentIndex = 0;
                    
                    const playNext = () => {
                        if (currentIndex >= this.speechQueue.length) {
                            resolve();
                            return;
                        }
                        
                        const item = this.speechQueue[currentIndex++];
                        
                        if (item.type === 'speech') {
                            const utterance = new SpeechSynthesisUtterance(item.text);
                            utterance.voice = item.utterance.voice;
                            utterance.lang = item.utterance.lang;
                            utterance.rate = item.utterance.rate;
                            utterance.pitch = item.utterance.pitch;
                            utterance.volume = item.utterance.volume;
                            
                            utterance.onend = () => setTimeout(playNext, 100);
                            utterance.onerror = () => setTimeout(playNext, 100);
                            
                            speechSynthesis.speak(utterance);
                        } else if (item.type === 'pause') {
                            setTimeout(playNext, item.duration);
                        }
                    };
                    
                    playNext();
                });
            }
            
            generateTextFile() {
                let content = 'üéØ Ëã±ÊñáÂè£Ë™™Âá∫È°åÁ≥ªÁµ± - Ë™ûÈü≥ËÖ≥Êú¨\n';
                content += '='.repeat(50) + '\n\n';
                content += `ÁîüÊàêÊôÇÈñìÔºö${new Date().toLocaleString('zh-TW')}\n`;
                content += `Ê®°ÂºèÔºö${this.currentMode === 'premium' ? 'È´òÂìÅË≥™Ê®°Âºè' : 'ÂÖçË≤ªÊ®°Âºè'}\n\n`;
                
                this.scriptItems.forEach((item, index) => {
                    if (item.type === 'text') {
                        content += `${index + 1}. üì¢ ${item.text}\n`;
                        content += `   Ë™ûÈü≥Ôºö${item.voice}\n\n`;
                    } else {
                        content += `${index + 1}. ‚è∏Ô∏è Êö´ÂÅú ${item.duration} Áßí\n\n`;
                    }
                });
                
                this.currentBlob = new Blob([content], { type: 'text/plain;charset=utf-8' });
            }
            
            showResults() {
                document.getElementById('resultSection').style.display = 'block';
                document.getElementById('resultSection').scrollIntoView({ behavior: 'smooth' });
            }
            
            playAudio() {
                if (!this.currentAudio) {
                    this.showMessage('Ë´ãÂÖàÁîüÊàêË™ûÈü≥Ê™îÊ°à', 'error');
                    return;
                }
                
                const playBtn = document.getElementById('playBtn');
                playBtn.textContent = 'üîä Êí≠Êîæ‰∏≠...';
                playBtn.disabled = true;
                
                const resetButton = () => {
                    playBtn.textContent = '‚ñ∂Ô∏è Êí≠ÊîæÂÆåÊï¥Ë™ûÈü≥';
                    playBtn.disabled = false;
                };
                
                if (this.currentMode === 'premium') {
                    this.currentAudio.onended = resetButton;
                    this.currentAudio.onerror = resetButton;
                    this.currentAudio.play();
                } else {
                    this.currentAudio.play().then(resetButton).catch((error) => {
                        console.error('Êí≠ÊîæÂ§±Êïó:', error);
                        resetButton();
                    });
                }
            }
            
            downloadAudio() {
                if (!this.currentBlob) {
                    this.showMessage('Ë´ãÂÖàÁîüÊàêË™ûÈü≥Ê™îÊ°à', 'error');
                    return;
                }
                
                const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
                const extension = this.currentMode === 'premium' ? 'mp3' : 'txt';
                const fileName = `Ë™ûÈü≥ËÖ≥Êú¨_${this.currentMode === 'premium' ? 'È´òÂìÅË≥™' : 'ÂÖçË≤ªÁâà'}_${timestamp}.${extension}`;
                
                const url = URL.createObjectURL(this.currentBlob);
                const a = document.createElement('a');
                a.href = url;
                a.download = fileName;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                this.showMessage(`Ê™îÊ°à‰∏ãËºâÈñãÂßãÔºö${fileName}`, 'success');
            }
            
            showMessage(message, type) {
                const statusMessage = document.getElementById('statusMessage');
                statusMessage.innerHTML = `<div class="message ${type}">${message}</div>`;
                
                if (type === 'success') {
                    setTimeout(() => {
                        statusMessage.innerHTML = '';
                    }, 5000);
                }
            }
        }
        
        // ÂàùÂßãÂåñ
        let speechGen;
        
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                speechGen = new SpeechGenerator();
            });
        } else {
            speechGen = new SpeechGenerator();
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'994f72fb86cca9a9',t:'MTc2MTUzOTMzMi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
