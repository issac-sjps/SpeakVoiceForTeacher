<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>英文口說出題系統</title>
    <style>
        body {
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100%;
        }
        
        html {
            height: 100%;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100%;
        }
        
        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }
        
        .card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 20px;
        }
        
        .form-group {
            margin-bottom: 25px;
        }
        
        label {
            display: block;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
            font-size: 1.1rem;
        }
        
        textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            font-size: 16px;
            font-family: inherit;
            resize: vertical;
            transition: border-color 0.3s ease;
        }
        
        textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .generate-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 1.1rem;
            font-weight: 600;
            border-radius: 10px;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            width: 100%;
        }
        
        .generate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .generate-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .result-section {
            display: none;
            margin-top: 30px;
        }
        
        .audio-player {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            margin-bottom: 20px;
        }
        
        .play-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            margin: 0 10px;
            transition: background-color 0.3s ease;
        }
        
        .play-btn:hover {
            background: #218838;
        }
        
        .download-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            margin: 0 10px;
            transition: background-color 0.3s ease;
        }
        
        .download-btn:hover {
            background: #0056b3;
        }
        
        .text-display {
            background: #f8f9fa;
            border-left: 4px solid #667eea;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 15px;
        }
        
        .english-text {
            font-size: 1.2rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 10px;
        }
        
        .chinese-text {
            font-size: 1rem;
            color: #666;
        }
        
        .loading {
            text-align: center;
            color: #667eea;
            font-weight: 600;
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #dc3545;
        }
        
        .success {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #28a745;
        }
        
        .script-editor {
            margin-top: 20px;
        }
        
        .script-item {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            position: relative;
            cursor: move;
            transition: all 0.3s ease;
        }
        
        .script-item:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }
        
        .script-item.dragging {
            opacity: 0.5;
            transform: rotate(5deg);
            z-index: 1000;
        }
        
        .script-item.drag-over {
            border-color: #667eea;
            background: #f0f4ff;
        }
        
        .drag-handle {
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: #6c757d;
            font-size: 18px;
            cursor: grab;
        }
        
        .drag-handle:active {
            cursor: grabbing;
        }
        
        .script-item.text-item {
            border-left: 4px solid #28a745;
            padding-left: 50px;
        }
        
        .script-item.pause-item {
            border-left: 4px solid #ffc107;
            background: #fff8e1;
            padding-left: 50px;
        }
        
        .item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .item-type {
            font-weight: 600;
            color: #495057;
        }
        
        .delete-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .delete-btn:hover {
            background: #c82333;
        }
        
        .text-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
            margin-bottom: 15px;
            resize: vertical;
        }
        
        .voice-select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 14px;
        }
        
        .pause-controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .pause-slider {
            flex: 1;
        }
        
        .pause-value {
            font-weight: 600;
            color: #ffc107;
            min-width: 60px;
        }
        
        .add-buttons {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .add-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s ease;
        }
        
        .add-btn:hover {
            background: #5a6268;
        }
        
        .text-btn {
            background: #28a745;
        }
        
        .text-btn:hover {
            background: #218838;
        }
        
        .pause-btn {
            background: #ffc107;
            color: #212529;
        }
        
        .pause-btn:hover {
            background: #e0a800;
        }
        
        .empty-state {
            text-align: center;
            color: #6c757d;
            padding: 40px;
            border: 2px dashed #dee2e6;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .voice-mode-selector {
            margin-bottom: 30px;
        }
        
        .mode-buttons {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .mode-btn {
            flex: 1;
            padding: 15px 20px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            background: white;
            color: #495057;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .mode-btn:hover {
            border-color: #667eea;
            color: #667eea;
        }
        
        .mode-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
        }
        
        .mode-info {
            margin-top: 15px;
        }
        
        .info-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            border-left: 4px solid #28a745;
        }
        
        .info-card h4 {
            margin: 0 0 15px 0;
            color: #333;
        }
        
        .info-card ul {
            margin: 0;
            padding-left: 20px;
        }
        
        .info-card li {
            margin-bottom: 8px;
            color: #555;
        }
        
        .premium-info {
            border-left-color: #ffc107;
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>🎯 英文口說出題系統</h1>
            <p>輸入英文和中文原文，生成道地美式發音的MP3檔案</p>
        </header>
        
        <main>
            <div class="card">
                <div class="voice-mode-selector">
                    <h3>🎵 語音模式選擇</h3>
                    <div class="mode-buttons">
                        <button type="button" class="mode-btn active" id="freeMode">
                            🆓 免費模式 (瀏覽器內建)
                        </button>
                        <button type="button" class="mode-btn" id="premiumMode">
                            ⭐ 高品質模式 (需要 API Key)
                        </button>
                    </div>
                    
                    <div class="api-setup" id="apiSetup" style="display: none;">
                        <div class="form-group">
                            <label for="apiKey">Google Cloud Text-to-Speech API Key：</label>
                            <input 
                                type="password" 
                                id="apiKey" 
                                placeholder="請輸入您的 Google Cloud API Key"
                                style="width: 100%; padding: 12px; border: 2px solid #e1e5e9; border-radius: 8px; font-size: 16px;"
                            >
                            <small style="color: #666; display: block; margin-top: 5px;">
                                <strong>📋 設定步驟：</strong><br>
                                1. 到 <a href="https://console.cloud.google.com/" target="_blank" rel="noopener noreferrer">Google Cloud Console</a> 建立專案<br>
                                2. 啟用 <a href="https://console.cloud.google.com/apis/library/texttospeech.googleapis.com" target="_blank" rel="noopener noreferrer">Text-to-Speech API</a><br>
                                3. 到 <a href="https://console.cloud.google.com/apis/credentials" target="_blank" rel="noopener noreferrer">憑證頁面</a> 建立 API Key<br>
                                💾 您的 API Key 會自動儲存在這台電腦上，下次開啟會自動載入
                            </small>
                        </div>
                    </div>
                    
                    <div class="mode-info" id="modeInfo">
                        <div class="info-card free-info">
                            <h4>🆓 免費模式特色</h4>
                            <ul>
                                <li>✅ 完全免費，無需註冊</li>
                                <li>✅ 支援多種語音選項</li>
                                <li>✅ 即時生成，無需等待</li>
                                <li>⚠️ 音質較基本</li>
                                <li>⚠️ 無法下載 MP3 檔案</li>
                            </ul>
                        </div>
                    </div>
                </div>
                
                <div class="script-editor">
                    <h3>📝 語音腳本編輯器</h3>
                    <div id="scriptItems"></div>
                    
                    <div class="add-buttons">
                        <button type="button" class="add-btn text-btn" id="addTextBtn">
                            ➕ 新增文字段落
                        </button>
                        <button type="button" class="add-btn pause-btn" id="addPauseBtn">
                            ⏸️ 新增暫停
                        </button>
                    </div>
                    
                    <button type="button" class="generate-btn" id="generateBtn">
                        🎵 生成完整語音檔案
                    </button>
                </div>
            </div>
            
            <div class="card result-section" id="resultSection">
                <h3>🎵 語音檔案已生成</h3>
                
                <div class="audio-player">
                    <p>您的語音腳本已成功生成為 MP3 檔案：</p>
                    <button class="play-btn" id="playBtn">▶️ 播放完整語音</button>
                    <button class="download-btn" id="downloadBtn">⬇️ 下載 MP3 檔案</button>
                </div>
                
                <div id="statusMessage"></div>
            </div>
        </main>
    </div>

    <script>
        class ScriptBasedSpeechGenerator {
            constructor() {
                this.currentAudio = null;
                this.currentBlob = null;
                this.apiKey = '';
                this.scriptItems = [];
                this.itemCounter = 0;
                this.isPremiumMode = false;
                this.initializeElements();
                this.bindEvents();
                this.loadSavedApiKey();
                this.showEmptyState();
            }
            
            initializeElements() {
                this.apiKeyInput = document.getElementById('apiKey');
                this.scriptItemsContainer = document.getElementById('scriptItems');
                this.addTextBtn = document.getElementById('addTextBtn');
                this.addPauseBtn = document.getElementById('addPauseBtn');
                this.generateBtn = document.getElementById('generateBtn');
                this.resultSection = document.getElementById('resultSection');
                this.playBtn = document.getElementById('playBtn');
                this.downloadBtn = document.getElementById('downloadBtn');
                this.statusMessage = document.getElementById('statusMessage');
                this.freeModeBtn = document.getElementById('freeMode');
                this.premiumModeBtn = document.getElementById('premiumMode');
                this.apiSetup = document.getElementById('apiSetup');
                this.modeInfo = document.getElementById('modeInfo');
            }
            
            bindEvents() {
                this.addTextBtn.addEventListener('click', () => this.addTextItem());
                this.addPauseBtn.addEventListener('click', () => this.addPauseItem());
                this.generateBtn.addEventListener('click', () => this.generateScript());
                this.playBtn.addEventListener('click', () => this.playAudio());
                this.downloadBtn.addEventListener('click', () => this.downloadAudio());
                this.apiKeyInput.addEventListener('input', (e) => this.saveApiKey(e.target.value));
                this.freeModeBtn.addEventListener('click', () => this.switchToFreeMode());
                this.premiumModeBtn.addEventListener('click', () => this.switchToPremiumMode());
            }
            
            loadSavedApiKey() {
                const savedKey = localStorage.getItem('googleAIApiKey');
                if (savedKey) {
                    this.apiKeyInput.value = savedKey;
                    this.apiKey = savedKey;
                    console.log('已載入儲存的 API Key');
                }
            }
            
            saveApiKey(key) {
                this.apiKey = key.trim();
                if (this.apiKey) {
                    localStorage.setItem('googleAIApiKey', this.apiKey);
                    console.log('API Key 已儲存到本地');
                    this.showMessage('✅ API Key 已儲存！下次開啟網頁會自動載入', 'success');
                } else {
                    localStorage.removeItem('googleAIApiKey');
                    console.log('API Key 已清除');
                }
            }
            
            switchToFreeMode() {
                this.isPremiumMode = false;
                this.freeModeBtn.classList.add('active');
                this.premiumModeBtn.classList.remove('active');
                this.apiSetup.style.display = 'none';
                this.updateModeInfo();
                this.renderScriptItems(); // 重新渲染以更新語音選項
            }
            
            switchToPremiumMode() {
                this.isPremiumMode = true;
                this.premiumModeBtn.classList.add('active');
                this.freeModeBtn.classList.remove('active');
                this.apiSetup.style.display = 'block';
                this.updateModeInfo();
                this.renderScriptItems(); // 重新渲染以更新語音選項
            }
            
            updateModeInfo() {
                if (this.isPremiumMode) {
                    this.modeInfo.innerHTML = `
                        <div class="info-card premium-info">
                            <h4>⭐ 高品質模式特色</h4>
                            <ul>
                                <li>✅ 專業級語音品質</li>
                                <li>✅ 多種自然語音選項</li>
                                <li>✅ 可下載高品質 MP3</li>
                                <li>✅ 支援語音參數調整</li>
                                <li>⚠️ 需要 Google Cloud API Key</li>
                            </ul>
                        </div>
                    `;
                } else {
                    this.modeInfo.innerHTML = `
                        <div class="info-card free-info">
                            <h4>🆓 免費模式特色</h4>
                            <ul>
                                <li>✅ 完全免費，無需註冊</li>
                                <li>✅ 支援多種語音選項</li>
                                <li>✅ 即時生成，無需等待</li>
                                <li>✅ 可下載音頻檔案 (WebM 格式)</li>
                                <li>✅ 可下載詳細腳本文字檔</li>
                                <li>⚠️ 音質較基本</li>
                                <li>⚠️ 音頻格式為 WebM (非 MP3)</li>
                            </ul>
                        </div>
                    `;
                }
            }
            
            getVoiceOptions(selectedVoice) {
                if (this.isPremiumMode) {
                    return `
                        <optgroup label="🇺🇸 英語語音">
                            <option value="en-US-Journey-D" ${selectedVoice === 'en-US-Journey-D' ? 'selected' : ''}>美式英語 (女性) - Journey</option>
                            <option value="en-US-Journey-F" ${selectedVoice === 'en-US-Journey-F' ? 'selected' : ''}>美式英語 (男性) - Journey</option>
                            <option value="en-US-Studio-O" ${selectedVoice === 'en-US-Studio-O' ? 'selected' : ''}>美式英語 (女性) - Studio</option>
                            <option value="en-US-Studio-Q" ${selectedVoice === 'en-US-Studio-Q' ? 'selected' : ''}>美式英語 (男性) - Studio</option>
                            <option value="en-US-Neural2-A" ${selectedVoice === 'en-US-Neural2-A' ? 'selected' : ''}>美式英語 (男性) - Neural2</option>
                            <option value="en-US-Neural2-C" ${selectedVoice === 'en-US-Neural2-C' ? 'selected' : ''}>美式英語 (女性) - Neural2</option>
                            <option value="en-US-Neural2-D" ${selectedVoice === 'en-US-Neural2-D' ? 'selected' : ''}>美式英語 (男性) - Neural2</option>
                            <option value="en-US-Neural2-E" ${selectedVoice === 'en-US-Neural2-E' ? 'selected' : ''}>美式英語 (女性) - Neural2</option>
                            <option value="en-GB-Neural2-A" ${selectedVoice === 'en-GB-Neural2-A' ? 'selected' : ''}>英式英語 (女性) - Neural2</option>
                            <option value="en-GB-Neural2-B" ${selectedVoice === 'en-GB-Neural2-B' ? 'selected' : ''}>英式英語 (男性) - Neural2</option>
                        </optgroup>
                        <optgroup label="🇹🇼 台灣中文">
                            <option value="cmn-TW-Standard-A" ${selectedVoice === 'cmn-TW-Standard-A' ? 'selected' : ''}>台灣國語 (女性) - 標準</option>
                            <option value="cmn-TW-Standard-B" ${selectedVoice === 'cmn-TW-Standard-B' ? 'selected' : ''}>台灣國語 (男性) - 標準</option>
                            <option value="cmn-TW-Standard-C" ${selectedVoice === 'cmn-TW-Standard-C' ? 'selected' : ''}>台灣國語 (男性) - 標準</option>
                            <option value="cmn-TW-Wavenet-A" ${selectedVoice === 'cmn-TW-Wavenet-A' ? 'selected' : ''}>台灣國語 (女性) - WaveNet</option>
                            <option value="cmn-TW-Wavenet-B" ${selectedVoice === 'cmn-TW-Wavenet-B' ? 'selected' : ''}>台灣國語 (男性) - WaveNet</option>
                            <option value="cmn-TW-Wavenet-C" ${selectedVoice === 'cmn-TW-Wavenet-C' ? 'selected' : ''}>台灣國語 (男性) - WaveNet</option>
                        </optgroup>
                        <optgroup label="🇨🇳 大陸中文">
                            <option value="cmn-CN-Standard-A" ${selectedVoice === 'cmn-CN-Standard-A' ? 'selected' : ''}>普通話 (女性) - 標準</option>
                            <option value="cmn-CN-Standard-B" ${selectedVoice === 'cmn-CN-Standard-B' ? 'selected' : ''}>普通話 (男性) - 標準</option>
                            <option value="cmn-CN-Standard-C" ${selectedVoice === 'cmn-CN-Standard-C' ? 'selected' : ''}>普通話 (男性) - 標準</option>
                            <option value="cmn-CN-Standard-D" ${selectedVoice === 'cmn-CN-Standard-D' ? 'selected' : ''}>普通話 (女性) - 標準</option>
                            <option value="cmn-CN-Wavenet-A" ${selectedVoice === 'cmn-CN-Wavenet-A' ? 'selected' : ''}>普通話 (女性) - WaveNet</option>
                            <option value="cmn-CN-Wavenet-B" ${selectedVoice === 'cmn-CN-Wavenet-B' ? 'selected' : ''}>普通話 (男性) - WaveNet</option>
                            <option value="cmn-CN-Wavenet-C" ${selectedVoice === 'cmn-CN-Wavenet-C' ? 'selected' : ''}>普通話 (男性) - WaveNet</option>
                            <option value="cmn-CN-Wavenet-D" ${selectedVoice === 'cmn-CN-Wavenet-D' ? 'selected' : ''}>普通話 (女性) - WaveNet</option>
                        </optgroup>
                        <optgroup label="🇭🇰 粵語">
                            <option value="yue-HK-Standard-A" ${selectedVoice === 'yue-HK-Standard-A' ? 'selected' : ''}>粵語 (女性) - 標準</option>
                            <option value="yue-HK-Standard-B" ${selectedVoice === 'yue-HK-Standard-B' ? 'selected' : ''}>粵語 (男性) - 標準</option>
                            <option value="yue-HK-Standard-C" ${selectedVoice === 'yue-HK-Standard-C' ? 'selected' : ''}>粵語 (女性) - 標準</option>
                            <option value="yue-HK-Standard-D" ${selectedVoice === 'yue-HK-Standard-D' ? 'selected' : ''}>粵語 (男性) - 標準</option>
                        </optgroup>
                        <optgroup label="🇯🇵 日語">
                            <option value="ja-JP-Neural2-B" ${selectedVoice === 'ja-JP-Neural2-B' ? 'selected' : ''}>日語 (女性) - Neural2</option>
                            <option value="ja-JP-Neural2-C" ${selectedVoice === 'ja-JP-Neural2-C' ? 'selected' : ''}>日語 (男性) - Neural2</option>
                            <option value="ja-JP-Neural2-D" ${selectedVoice === 'ja-JP-Neural2-D' ? 'selected' : ''}>日語 (男性) - Neural2</option>
                            <option value="ja-JP-Wavenet-A" ${selectedVoice === 'ja-JP-Wavenet-A' ? 'selected' : ''}>日語 (女性) - WaveNet</option>
                            <option value="ja-JP-Wavenet-B" ${selectedVoice === 'ja-JP-Wavenet-B' ? 'selected' : ''}>日語 (女性) - WaveNet</option>
                            <option value="ja-JP-Wavenet-C" ${selectedVoice === 'ja-JP-Wavenet-C' ? 'selected' : ''}>日語 (男性) - WaveNet</option>
                            <option value="ja-JP-Wavenet-D" ${selectedVoice === 'ja-JP-Wavenet-D' ? 'selected' : ''}>日語 (男性) - WaveNet</option>
                        </optgroup>
                        <optgroup label="🇰🇷 韓語">
                            <option value="ko-KR-Neural2-A" ${selectedVoice === 'ko-KR-Neural2-A' ? 'selected' : ''}>韓語 (女性) - Neural2</option>
                            <option value="ko-KR-Neural2-B" ${selectedVoice === 'ko-KR-Neural2-B' ? 'selected' : ''}>韓語 (女性) - Neural2</option>
                            <option value="ko-KR-Neural2-C" ${selectedVoice === 'ko-KR-Neural2-C' ? 'selected' : ''}>韓語 (男性) - Neural2</option>
                            <option value="ko-KR-Wavenet-A" ${selectedVoice === 'ko-KR-Wavenet-A' ? 'selected' : ''}>韓語 (女性) - WaveNet</option>
                            <option value="ko-KR-Wavenet-B" ${selectedVoice === 'ko-KR-Wavenet-B' ? 'selected' : ''}>韓語 (女性) - WaveNet</option>
                            <option value="ko-KR-Wavenet-C" ${selectedVoice === 'ko-KR-Wavenet-C' ? 'selected' : ''}>韓語 (男性) - WaveNet</option>
                            <option value="ko-KR-Wavenet-D" ${selectedVoice === 'ko-KR-Wavenet-D' ? 'selected' : ''}>韓語 (男性) - WaveNet</option>
                        </optgroup>
                    `;
                } else {
                    return `
                        <optgroup label="🇺🇸 英語語音">
                            <option value="Microsoft Zira - English (United States)" ${selectedVoice === 'Microsoft Zira - English (United States)' ? 'selected' : ''}>美式英語 (女性)</option>
                            <option value="Microsoft David - English (United States)" ${selectedVoice === 'Microsoft David - English (United States)' ? 'selected' : ''}>美式英語 (男性)</option>
                            <option value="Google US English" ${selectedVoice === 'Google US English' ? 'selected' : ''}>Google 美式英語</option>
                            <option value="native" ${selectedVoice === 'native' ? 'selected' : ''}>系統預設英語</option>
                        </optgroup>
                        <optgroup label="🇹🇼 中文語音">
                            <option value="Microsoft Hanhan - Chinese (Taiwan)" ${selectedVoice === 'Microsoft Hanhan - Chinese (Taiwan)' ? 'selected' : ''}>台灣中文 (女性)</option>
                            <option value="Microsoft Zhiwei - Chinese (Taiwan)" ${selectedVoice === 'Microsoft Zhiwei - Chinese (Taiwan)' ? 'selected' : ''}>台灣中文 (男性)</option>
                            <option value="Google 國語（臺灣）" ${selectedVoice === 'Google 國語（臺灣）' ? 'selected' : ''}>Google 台灣國語</option>
                            <option value="Microsoft Yaoyao - Chinese (Mainland)" ${selectedVoice === 'Microsoft Yaoyao - Chinese (Mainland)' ? 'selected' : ''}>大陸普通話 (女性)</option>
                            <option value="Microsoft Kangkang - Chinese (Mainland)" ${selectedVoice === 'Microsoft Kangkang - Chinese (Mainland)' ? 'selected' : ''}>大陸普通話 (男性)</option>
                            <option value="Google 普通话（中国大陆）" ${selectedVoice === 'Google 普通话（中国大陆）' ? 'selected' : ''}>Google 大陸普通話</option>
                            <option value="Microsoft Tracy - Chinese (Hong Kong)" ${selectedVoice === 'Microsoft Tracy - Chinese (Hong Kong)' ? 'selected' : ''}>香港粵語 (女性)</option>
                            <option value="Google 粤语（香港）" ${selectedVoice === 'Google 粤语（香港）' ? 'selected' : ''}>Google 香港粵語</option>
                        </optgroup>
                        <optgroup label="🇯🇵 日語語音">
                            <option value="Microsoft Ayumi - Japanese" ${selectedVoice === 'Microsoft Ayumi - Japanese' ? 'selected' : ''}>日語 (女性)</option>
                            <option value="Microsoft Ichiro - Japanese" ${selectedVoice === 'Microsoft Ichiro - Japanese' ? 'selected' : ''}>日語 (男性)</option>
                            <option value="Google 日本語" ${selectedVoice === 'Google 日本語' ? 'selected' : ''}>Google 日語</option>
                        </optgroup>
                        <optgroup label="🇰🇷 韓語語音">
                            <option value="Microsoft Heami - Korean" ${selectedVoice === 'Microsoft Heami - Korean' ? 'selected' : ''}>韓語 (女性)</option>
                            <option value="Google 한국어" ${selectedVoice === 'Google 한국어' ? 'selected' : ''}>Google 韓語</option>
                        </optgroup>
                    `;
                }
            }
            
            showEmptyState() {
                if (this.scriptItems.length === 0) {
                    this.scriptItemsContainer.innerHTML = `
                        <div class="empty-state">
                            <h4>📝 開始建立您的語音腳本</h4>
                            <p>點擊下方按鈕新增文字段落或暫停時間</p>
                        </div>
                    `;
                }
            }
            
            addTextItem() {
                const itemId = ++this.itemCounter;
                const defaultVoice = this.isPremiumMode ? 'cmn-TW-Standard-A' : 'Microsoft Hanhan - Chinese (Taiwan)';
                const item = {
                    id: itemId,
                    type: 'text',
                    text: '',
                    voice: defaultVoice
                };
                
                this.scriptItems.push(item);
                this.renderScriptItems();
            }
            
            addPauseItem() {
                const itemId = ++this.itemCounter;
                const item = {
                    id: itemId,
                    type: 'pause',
                    duration: 2.0
                };
                
                this.scriptItems.push(item);
                this.renderScriptItems();
            }
            
            renderScriptItems() {
                if (this.scriptItems.length === 0) {
                    this.showEmptyState();
                    return;
                }
                
                this.scriptItemsContainer.innerHTML = this.scriptItems.map(item => {
                    if (item.type === 'text') {
                        return this.renderTextItem(item);
                    } else {
                        return this.renderPauseItem(item);
                    }
                }).join('');
                
                // 重新綁定事件
                this.bindItemEvents();
            }
            
            renderTextItem(item) {
                return `
                    <div class="script-item text-item" data-id="${item.id}" draggable="true">
                        <div class="drag-handle">⋮⋮</div>
                        <div class="item-header">
                            <span class="item-type">🗣️ 文字段落</span>
                            <button class="delete-btn" onclick="generator.deleteItem(${item.id})">刪除</button>
                        </div>
                        <textarea 
                            class="text-input" 
                            placeholder="請輸入要朗讀的文字..."
                            rows="3"
                            onchange="generator.updateItemText(${item.id}, this.value)"
                        >${item.text}</textarea>
                        <select 
                            class="voice-select" 
                            onchange="generator.updateItemVoice(${item.id}, this.value)"
                        >
                            ${generator.getVoiceOptions(item.voice)}
                        </select>
                    </div>
                `;
            }
            
            renderPauseItem(item) {
                return `
                    <div class="script-item pause-item" data-id="${item.id}" draggable="true">
                        <div class="drag-handle">⋮⋮</div>
                        <div class="item-header">
                            <span class="item-type">⏸️ 暫停時間</span>
                            <button class="delete-btn" onclick="generator.deleteItem(${item.id})">刪除</button>
                        </div>
                        <div class="pause-controls">
                            <input 
                                type="range" 
                                class="pause-slider" 
                                min="0.5" 
                                max="10" 
                                step="0.5" 
                                value="${item.duration}"
                                oninput="generator.updatePauseDuration(${item.id}, this.value)"
                            >
                            <span class="pause-value">${item.duration.toFixed(1)} 秒</span>
                        </div>
                    </div>
                `;
            }
            
            bindItemEvents() {
                // 綁定拖拽事件
                const scriptItems = this.scriptItemsContainer.querySelectorAll('.script-item');
                scriptItems.forEach(item => {
                    item.addEventListener('dragstart', (e) => this.handleDragStart(e));
                    item.addEventListener('dragover', (e) => this.handleDragOver(e));
                    item.addEventListener('drop', (e) => this.handleDrop(e));
                    item.addEventListener('dragend', (e) => this.handleDragEnd(e));
                    item.addEventListener('dragenter', (e) => this.handleDragEnter(e));
                    item.addEventListener('dragleave', (e) => this.handleDragLeave(e));
                });
            }
            
            updateItemText(itemId, text) {
                const item = this.scriptItems.find(i => i.id === itemId);
                if (item) {
                    item.text = text;
                }
            }
            
            updateItemVoice(itemId, voice) {
                const item = this.scriptItems.find(i => i.id === itemId);
                if (item) {
                    item.voice = voice;
                }
            }
            
            updatePauseDuration(itemId, duration) {
                const item = this.scriptItems.find(i => i.id === itemId);
                if (item) {
                    item.duration = parseFloat(duration);
                    // 更新顯示
                    const pauseValue = document.querySelector(`[data-id="${itemId}"] .pause-value`);
                    if (pauseValue) {
                        pauseValue.textContent = `${parseFloat(duration).toFixed(1)} 秒`;
                    }
                }
            }
            
            deleteItem(itemId) {
                this.scriptItems = this.scriptItems.filter(item => item.id !== itemId);
                this.renderScriptItems();
            }
            
            // 拖拽處理函數
            handleDragStart(e) {
                this.draggedItemId = parseInt(e.target.dataset.id);
                e.target.classList.add('dragging');
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setData('text/html', e.target.outerHTML);
            }
            
            handleDragOver(e) {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
            }
            
            handleDragEnter(e) {
                e.preventDefault();
                if (e.target.classList.contains('script-item') && 
                    parseInt(e.target.dataset.id) !== this.draggedItemId) {
                    e.target.classList.add('drag-over');
                }
            }
            
            handleDragLeave(e) {
                if (e.target.classList.contains('script-item')) {
                    e.target.classList.remove('drag-over');
                }
            }
            
            handleDrop(e) {
                e.preventDefault();
                const targetId = parseInt(e.target.closest('.script-item').dataset.id);
                
                if (targetId && targetId !== this.draggedItemId) {
                    this.reorderItems(this.draggedItemId, targetId);
                }
                
                // 清除所有拖拽樣式
                this.scriptItemsContainer.querySelectorAll('.script-item').forEach(item => {
                    item.classList.remove('drag-over');
                });
            }
            
            handleDragEnd(e) {
                e.target.classList.remove('dragging');
                this.draggedItemId = null;
                
                // 清除所有拖拽樣式
                this.scriptItemsContainer.querySelectorAll('.script-item').forEach(item => {
                    item.classList.remove('drag-over', 'dragging');
                });
            }
            
            reorderItems(draggedId, targetId) {
                const draggedIndex = this.scriptItems.findIndex(item => item.id === draggedId);
                const targetIndex = this.scriptItems.findIndex(item => item.id === targetId);
                
                if (draggedIndex === -1 || targetIndex === -1) return;
                
                // 移除被拖拽的項目
                const draggedItem = this.scriptItems.splice(draggedIndex, 1)[0];
                
                // 插入到目標位置
                this.scriptItems.splice(targetIndex, 0, draggedItem);
                
                // 重新渲染
                this.renderScriptItems();
                
                // 顯示成功訊息
                this.showMessage('✅ 段落順序已更新！', 'success');
            }
            
            async generateScript() {
                if (this.isPremiumMode && !this.apiKey) {
                    this.showMessage('高品質模式需要 Google Cloud API Key，請先輸入或切換到免費模式', 'error');
                    return;
                }
                
                if (this.scriptItems.length === 0) {
                    this.showMessage('請先新增一些文字段落或暫停時間', 'error');
                    return;
                }
                
                // 檢查是否有文字內容
                const hasText = this.scriptItems.some(item => item.type === 'text' && item.text.trim());
                if (!hasText) {
                    this.showMessage('請至少新增一個包含文字的段落', 'error');
                    return;
                }
                
                this.generateBtn.disabled = true;
                this.generateBtn.textContent = '🔄 生成中...';
                this.showMessage('正在生成語音檔案，請稍候...', 'loading');
                
                try {
                    if (this.isPremiumMode) {
                        await this.generateSpeechWithAPI();
                    } else {
                        await this.generateSpeechWithBrowser();
                    }
                } catch (error) {
                    this.showMessage(`生成語音時發生錯誤：${error.message}`, 'error');
                    console.error('Speech generation error:', error);
                } finally {
                    this.generateBtn.disabled = false;
                    this.generateBtn.textContent = '🎵 生成完整語音檔案';
                }
            }
            
            async generateSpeechWithAPI() {
                console.log('開始生成語音，API Key:', this.apiKey ? '已設定' : '未設定');
                console.log('腳本項目數量:', this.scriptItems.length);
                
                // 建立簡化的文字內容（不使用複雜的 SSML）
                let textContent = '';
                
                for (const item of this.scriptItems) {
                    if (item.type === 'text' && item.text.trim()) {
                        textContent += item.text.trim() + ' ';
                        console.log('添加文字:', item.text.trim());
                    } else if (item.type === 'pause') {
                        // 用句號來模擬暫停
                        textContent += '. ';
                        console.log('添加暫停:', item.duration + '秒');
                    }
                }
                
                if (!textContent.trim()) {
                    throw new Error('沒有找到要朗讀的文字內容');
                }
                
                console.log('最終文字內容:', textContent);
                
                // 使用第一個文字項目的語音設定
                const firstTextItem = this.scriptItems.find(item => item.type === 'text');
                const voiceName = firstTextItem ? firstTextItem.voice : 'en-US-Journey-D';
                
                // 根據語音名稱自動判斷語言代碼
                const getLanguageCode = (voiceName) => {
                    if (voiceName.startsWith('en-US') || voiceName.includes('English (United States)')) return 'en-US';
                    if (voiceName.startsWith('en-GB') || voiceName.includes('English (United Kingdom)')) return 'en-GB';
                    if (voiceName.startsWith('cmn-TW') || voiceName.includes('Chinese (Taiwan)')) return 'cmn-TW';
                    if (voiceName.startsWith('cmn-CN') || voiceName.includes('Chinese (Mainland)')) return 'cmn-CN';
                    if (voiceName.startsWith('yue-HK') || voiceName.includes('Chinese (Hong Kong)')) return 'yue-HK';
                    if (voiceName.startsWith('ja-JP') || voiceName.includes('Japanese')) return 'ja-JP';
                    if (voiceName.startsWith('ko-KR') || voiceName.includes('Korean')) return 'ko-KR';
                    return 'en-US'; // 預設
                };
                
                const languageCode = getLanguageCode(voiceName);
                
                try {
                    console.log('發送 API 請求...');
                    const requestBody = {
                        input: {
                            text: textContent.trim()
                        },
                        voice: {
                            languageCode: languageCode,
                            name: voiceName
                        },
                        audioConfig: {
                            audioEncoding: 'MP3',
                            speakingRate: 0.9,
                            pitch: 0.0,
                            volumeGainDb: 0.0
                        }
                    };
                    
                    console.log('請求內容:', requestBody);
                    
                    const response = await fetch(`https://texttospeech.googleapis.com/v1/text:synthesize?key=${this.apiKey}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(requestBody)
                    });
                    
                    console.log('API 回應狀態:', response.status);
                    
                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('API 錯誤回應:', errorText);
                        let errorData;
                        try {
                            errorData = JSON.parse(errorText);
                        } catch (e) {
                            throw new Error(`API 請求失敗 (${response.status}): ${errorText}`);
                        }
                        throw new Error(errorData.error?.message || `API 請求失敗 (${response.status})`);
                    }
                    
                    const data = await response.json();
                    console.log('API 回應成功，音頻內容長度:', data.audioContent ? data.audioContent.length : 0);
                    
                    if (!data.audioContent) {
                        throw new Error('API 回應中沒有音頻內容');
                    }
                    
                    // 將 base64 音頻轉換為 Blob
                    const audioBytes = atob(data.audioContent);
                    const audioArray = new Uint8Array(audioBytes.length);
                    for (let i = 0; i < audioBytes.length; i++) {
                        audioArray[i] = audioBytes.charCodeAt(i);
                    }
                    
                    this.currentBlob = new Blob([audioArray], { type: 'audio/mpeg' });
                    this.currentAudio = new Audio(URL.createObjectURL(this.currentBlob));
                    
                    console.log('音頻檔案生成成功，大小:', this.currentBlob.size, 'bytes');
                    
                    // 顯示結果
                    this.displayResults();
                    
                } catch (error) {
                    console.error('Google API 錯誤:', error);
                    
                    // 檢查不同類型的 API 錯誤
                    if (error.message.includes('has not been used') || error.message.includes('is disabled')) {
                        this.showMessage(`
                            ❌ Google Text-to-Speech API 尚未啟用！<br><br>
                            <strong>請按照以下步驟設定：</strong><br>
                            1. 前往 <a href="https://console.cloud.google.com/" target="_blank" rel="noopener noreferrer">Google Cloud Console</a><br>
                            2. 選擇或建立一個專案<br>
                            3. 啟用 <a href="https://console.cloud.google.com/apis/library/texttospeech.googleapis.com" target="_blank" rel="noopener noreferrer">Text-to-Speech API</a><br>
                            4. 到 <a href="https://console.cloud.google.com/apis/credentials" target="_blank" rel="noopener noreferrer">憑證頁面</a> 建立 API Key<br>
                            5. 將新的 API Key 貼到上方輸入框<br><br>
                            💡 <strong>提示：</strong>啟用 API 後可能需要等待幾分鐘才能使用
                        `, 'error');
                    } else if (error.message.includes('blocked') || error.message.includes('PERMISSION_DENIED') || error.message.includes('API_KEY_SERVICE_BLOCKED')) {
                        this.showMessage(`
                            🚫 <strong>API 服務被阻擋！</strong><br><br>
                            根據錯誤代碼 <code>API_KEY_SERVICE_BLOCKED</code>，您的 Google Cloud 專案中 Text-to-Speech API 被阻擋了。<br><br>
                            
                            <strong>🔧 立即解決方案：</strong><br>
                            1. <strong>啟用 API：</strong>前往 <a href="https://console.cloud.google.com/apis/library/texttospeech.googleapis.com" target="_blank" rel="noopener noreferrer" style="color: #007bff; font-weight: bold;">Google Cloud Console - Text-to-Speech API</a><br>
                            2. <strong>點擊「啟用」按鈕</strong>（如果顯示已啟用，請先停用再重新啟用）<br>
                            3. <strong>設定計費：</strong>到 <a href="https://console.cloud.google.com/billing" target="_blank" rel="noopener noreferrer" style="color: #007bff; font-weight: bold;">計費頁面</a> 確保已啟用計費帳戶<br>
                            4. <strong>檢查配額：</strong>到 <a href="https://console.cloud.google.com/iam-admin/quotas" target="_blank" rel="noopener noreferrer" style="color: #007bff; font-weight: bold;">配額頁面</a> 確認 Text-to-Speech 配額<br><br>
                            
                            <strong>⚠️ 常見問題：</strong><br>
                            • 新建立的 Google Cloud 專案需要啟用計費才能使用 API<br>
                            • 免費試用額度用完後需要升級到付費帳戶<br>
                            • API Key 可能有地區或服務限制<br><br>
                            
                            <strong>🔄 自動切換到免費模式...</strong><br>
                            <span style="color: #28a745;">2 秒後將自動切換到瀏覽器內建語音，完全免費且無需設定！</span>
                        `, 'error');
                    } else if (error.message.includes('INVALID_ARGUMENT') || error.message.includes('400')) {
                        this.showMessage(`
                            ⚠️ API 請求參數錯誤！<br><br>
                            <strong>可能的問題：</strong><br>
                            • 文字內容格式不正確<br>
                            • 語音參數設定有誤<br>
                            • API Key 格式錯誤<br><br>
                            💡 <strong>建議：</strong>切換到免費模式或檢查輸入內容
                        `, 'error');
                    } else if (error.message.includes('UNAUTHENTICATED') || error.message.includes('401')) {
                        this.showMessage(`
                            🔑 API Key 驗證失敗！<br><br>
                            <strong>請檢查：</strong><br>
                            • API Key 是否正確複製<br>
                            • API Key 是否已過期<br>
                            • 是否使用了正確的 Google Cloud 專案<br><br>
                            💡 <strong>建議：</strong>重新產生一個新的 API Key
                        `, 'error');
                    } else {
                        // 其他 API 錯誤，自動切換到免費模式
                        this.showMessage(`
                            ❌ Google API 發生錯誤：${error.message}<br><br>
                            🔄 <strong>自動切換到免費模式...</strong><br>
                            免費模式使用瀏覽器內建語音，完全免費且無需設定！
                        `, 'error');
                        
                        // 延遲 2 秒後自動切換並重新生成
                        setTimeout(async () => {
                            this.switchToFreeMode();
                            this.showMessage('已切換到免費模式，正在重新生成語音...', 'loading');
                            try {
                                await this.generateSpeechWithBrowser();
                            } catch (browserError) {
                                this.showMessage(`瀏覽器語音也失敗了：${browserError.message}`, 'error');
                                await this.generateSpeechFallback();
                            }
                        }, 2000);
                    }
                }
            }
            
            async generateSpeechWithBrowser() {
                if (!('speechSynthesis' in window)) {
                    throw new Error('您的瀏覽器不支援語音合成功能');
                }
                
                console.log('使用瀏覽器內建語音合成');
                
                // 停止任何正在播放的語音
                speechSynthesis.cancel();
                
                // 等待語音列表載入完成
                await this.waitForVoices();
                
                // 建立語音腳本
                this.speechQueue = [];
                
                for (const item of this.scriptItems) {
                    if (item.type === 'text' && item.text.trim()) {
                        const utterance = new SpeechSynthesisUtterance(item.text.trim());
                        
                        // 設定語音參數
                        utterance.lang = 'en-US';
                        utterance.rate = 0.9;
                        utterance.pitch = 1.0;
                        utterance.volume = 1.0;
                        
                        // 嘗試設定指定的語音
                        const voices = speechSynthesis.getVoices();
                        let selectedVoice = null;
                        
                        console.log('可用語音數量:', voices.length);
                        console.log('前5個語音:', voices.slice(0, 5).map(v => v.name));
                        
                        // 根據語音名稱設定語言和語音
                        if (item.voice === 'native') {
                            selectedVoice = voices.find(voice => voice.lang.includes('zh-TW') || voice.lang.includes('zh-CN')) || voices[0];
                            utterance.lang = 'zh-TW';
                        } else if (item.voice.includes('Chinese (Taiwan)') || item.voice.includes('臺灣') || item.voice.includes('台灣')) {
                            selectedVoice = voices.find(voice => 
                                voice.name.includes('Hanhan') || 
                                voice.name.includes('Zhiwei') ||
                                voice.lang.includes('zh-TW')
                            );
                            utterance.lang = 'zh-TW';
                        } else if (item.voice.includes('Chinese (Mainland)') || item.voice.includes('中国大陆') || item.voice.includes('普通话')) {
                            selectedVoice = voices.find(voice => 
                                voice.name.includes('Yaoyao') || 
                                voice.name.includes('Kangkang') ||
                                voice.lang.includes('zh-CN')
                            );
                            utterance.lang = 'zh-CN';
                        } else if (item.voice.includes('Chinese (Hong Kong)') || item.voice.includes('粤语') || item.voice.includes('香港')) {
                            selectedVoice = voices.find(voice => 
                                voice.name.includes('Tracy') ||
                                voice.lang.includes('zh-HK')
                            );
                            utterance.lang = 'zh-HK';
                        } else if (item.voice.includes('Japanese') || item.voice.includes('日本語')) {
                            selectedVoice = voices.find(voice => 
                                voice.name.includes('Ayumi') || 
                                voice.name.includes('Ichiro') ||
                                voice.lang.includes('ja-JP')
                            );
                            utterance.lang = 'ja-JP';
                        } else if (item.voice.includes('Korean') || item.voice.includes('한국어')) {
                            selectedVoice = voices.find(voice => 
                                voice.name.includes('Heami') ||
                                voice.lang.includes('ko-KR')
                            );
                            utterance.lang = 'ko-KR';
                        } else if (item.voice.includes('English')) {
                            selectedVoice = voices.find(voice => 
                                voice.name.includes('Zira') || 
                                voice.name.includes('David') ||
                                voice.lang.includes('en-US')
                            );
                            utterance.lang = 'en-US';
                        } else {
                            // 嘗試直接匹配語音名稱
                            selectedVoice = voices.find(voice => 
                                voice.name.includes(item.voice) || 
                                voice.name === item.voice
                            );
                            if (!selectedVoice) {
                                selectedVoice = voices.find(voice => voice.lang.includes('zh-TW')) || voices[0];
                                utterance.lang = 'zh-TW';
                            }
                        }
                        
                        if (selectedVoice) {
                            utterance.voice = selectedVoice;
                        }
                        
                        this.speechQueue.push({
                            type: 'speech',
                            utterance: utterance,
                            text: item.text.trim()
                        });
                        
                        console.log('添加語音:', item.text.trim(), '語音:', selectedVoice?.name || '預設');
                        
                    } else if (item.type === 'pause') {
                        this.speechQueue.push({
                            type: 'pause',
                            duration: item.duration * 1000 // 轉換為毫秒
                        });
                        console.log('添加暫停:', item.duration + '秒');
                    }
                }
                
                if (this.speechQueue.length === 0) {
                    throw new Error('沒有找到要朗讀的內容');
                }
                
                // 設定播放控制
                this.currentAudio = {
                    play: () => this.playBrowserSpeech(),
                    pause: () => speechSynthesis.cancel(),
                    currentTime: 0,
                    onended: null,
                    onerror: null
                };
                
                // 生成 MP3 檔案
                await this.generateMP3FromBrowserSpeech();
                
                // 顯示結果
                this.displayResults();
                this.showMessage('🎵 免費語音已準備完成！您可以播放試聽或下載 MP3 檔案。', 'success');
            }
            
            // 等待語音列表載入的輔助函數
            waitForVoices() {
                return new Promise((resolve) => {
                    const voices = speechSynthesis.getVoices();
                    if (voices.length > 0) {
                        console.log('語音列表已載入，共', voices.length, '個語音');
                        resolve();
                        return;
                    }
                    
                    console.log('等待語音列表載入...');
                    let attempts = 0;
                    const maxAttempts = 10;
                    
                    const checkVoices = () => {
                        const voices = speechSynthesis.getVoices();
                        attempts++;
                        
                        if (voices.length > 0) {
                            console.log('語音列表載入完成，共', voices.length, '個語音');
                            resolve();
                        } else if (attempts >= maxAttempts) {
                            console.log('語音列表載入超時，使用預設設定');
                            resolve();
                        } else {
                            setTimeout(checkVoices, 100);
                        }
                    };
                    
                    // 監聽語音變更事件
                    speechSynthesis.addEventListener('voiceschanged', () => {
                        console.log('語音列表已更新');
                        resolve();
                    }, { once: true });
                    
                    // 開始檢查
                    setTimeout(checkVoices, 100);
                });
            }
            
            async generateMP3FromBrowserSpeech() {
                try {
                    console.log('開始錄製瀏覽器語音為 MP3...');
                    
                    // 建立音頻上下文
                    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    const destination = audioContext.createMediaStreamDestination();
                    
                    // 建立 MediaRecorder
                    const mediaRecorder = new MediaRecorder(destination.stream, {
                        mimeType: 'audio/webm;codecs=opus'
                    });
                    
                    const audioChunks = [];
                    
                    mediaRecorder.ondataavailable = (event) => {
                        if (event.data.size > 0) {
                            audioChunks.push(event.data);
                        }
                    };
                    
                    // 開始錄製
                    mediaRecorder.start();
                    
                    // 播放並錄製語音
                    await this.playAndRecordBrowserSpeech(audioContext, destination);
                    
                    // 停止錄製
                    mediaRecorder.stop();
                    
                    // 等待錄製完成
                    await new Promise((resolve) => {
                        mediaRecorder.onstop = () => {
                            const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                            this.currentBlob = audioBlob;
                            console.log('MP3 錄製完成，檔案大小:', audioBlob.size, 'bytes');
                            resolve();
                        };
                    });
                    
                    // 關閉音頻上下文
                    audioContext.close();
                    
                } catch (error) {
                    console.error('MP3 生成錯誤:', error);
                    // 如果錄製失敗，仍然允許播放
                    this.showMessage('MP3 錄製功能不可用，但您仍可以播放語音', 'error');
                }
            }
            
            async playAndRecordBrowserSpeech(audioContext, destination) {
                return new Promise((resolve, reject) => {
                    let currentIndex = 0;
                    
                    const playNext = () => {
                        if (currentIndex >= this.speechQueue.length) {
                            // 等待一秒後結束錄製
                            setTimeout(() => {
                                resolve();
                            }, 1000);
                            return;
                        }
                        
                        const item = this.speechQueue[currentIndex];
                        currentIndex++;
                        
                        if (item.type === 'speech') {
                            // 建立新的語音實例用於錄製
                            const utterance = new SpeechSynthesisUtterance(item.text);
                            utterance.voice = item.utterance.voice;
                            utterance.lang = item.utterance.lang;
                            utterance.rate = item.utterance.rate;
                            utterance.pitch = item.utterance.pitch;
                            utterance.volume = item.utterance.volume;
                            
                            utterance.onend = () => {
                                setTimeout(playNext, 100);
                            };
                            
                            utterance.onerror = (error) => {
                                console.error('錄製語音播放錯誤:', error);
                                setTimeout(playNext, 100); // 繼續下一個
                            };
                            
                            speechSynthesis.speak(utterance);
                            
                        } else if (item.type === 'pause') {
                            setTimeout(playNext, item.duration);
                        }
                    };
                    
                    playNext();
                });
            }
            
            async playBrowserSpeech() {
                return new Promise((resolve, reject) => {
                    let currentIndex = 0;
                    
                    const playNext = () => {
                        if (currentIndex >= this.speechQueue.length) {
                            if (this.currentAudio && this.currentAudio.onended) {
                                this.currentAudio.onended();
                            }
                            resolve();
                            return;
                        }
                        
                        const item = this.speechQueue[currentIndex];
                        currentIndex++;
                        
                        if (item.type === 'speech') {
                            item.utterance.onend = () => {
                                setTimeout(playNext, 100); // 短暫間隔
                            };
                            
                            item.utterance.onerror = (error) => {
                                console.error('語音播放錯誤:', error);
                                if (this.currentAudio && this.currentAudio.onerror) {
                                    this.currentAudio.onerror();
                                }
                                reject(error);
                            };
                            
                            speechSynthesis.speak(item.utterance);
                            
                        } else if (item.type === 'pause') {
                            setTimeout(playNext, item.duration);
                        }
                    };
                    
                    playNext();
                });
            }
            
            async generateSpeechFallback() {
                // 如果瀏覽器語音也失敗，創建文本檔案
                const scriptContent = this.scriptItems.map(item => {
                    if (item.type === 'text') {
                        return `文字: ${item.text} (語音: ${item.voice})`;
                    } else {
                        return `暫停: ${item.duration} 秒`;
                    }
                }).join('\n');
                
                const textContent = `語音腳本內容：\n\n${scriptContent}\n\n生成時間：${new Date().toLocaleString()}\n\n注意：此為備用方案，如需語音播放，請使用支援語音合成的瀏覽器`;
                this.currentBlob = new Blob([textContent], { type: 'text/plain;charset=utf-8' });
                
                this.displayResults();
                this.showMessage('瀏覽器不支援語音合成，已生成文字檔案。', 'success');
            }
            
            displayResults() {
                this.resultSection.style.display = 'block';
                this.showMessage('語音檔案生成完成！您可以播放試聽或下載檔案。', 'success');
                this.resultSection.scrollIntoView({ behavior: 'smooth' });
            }
            
            playAudio() {
                if (this.currentAudio) {
                    this.playBtn.textContent = '🔊 播放中...';
                    this.playBtn.disabled = true;
                    
                    if (this.isPremiumMode) {
                        // 高品質模式：播放 MP3 檔案
                        this.currentAudio.currentTime = 0;
                        this.currentAudio.play();
                        
                        this.currentAudio.onended = () => {
                            this.playBtn.textContent = '▶️ 播放完整語音';
                            this.playBtn.disabled = false;
                        };
                        
                        this.currentAudio.onerror = () => {
                            this.playBtn.textContent = '▶️ 播放完整語音';
                            this.playBtn.disabled = false;
                            this.showMessage('播放失敗，請重新生成語音檔案', 'error');
                        };
                    } else {
                        // 免費模式：使用瀏覽器語音合成
                        this.currentAudio.onended = () => {
                            this.playBtn.textContent = '▶️ 播放完整語音';
                            this.playBtn.disabled = false;
                        };
                        
                        this.currentAudio.onerror = () => {
                            this.playBtn.textContent = '▶️ 播放完整語音';
                            this.playBtn.disabled = false;
                            this.showMessage('播放失敗，請重新生成語音檔案', 'error');
                        };
                        
                        this.currentAudio.play().catch(error => {
                            console.error('播放錯誤:', error);
                            this.playBtn.textContent = '▶️ 播放完整語音';
                            this.playBtn.disabled = false;
                            this.showMessage('播放失敗，請重新生成語音檔案', 'error');
                        });
                    }
                } else {
                    this.showMessage('請先生成語音檔案', 'error');
                }
            }
            
            downloadAudio() {
                if (this.currentBlob) {
                    const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
                    let fileName, message;
                    
                    if (this.isPremiumMode) {
                        // 高品質模式：下載 MP3
                        const isMP3 = this.currentBlob.type === 'audio/mpeg';
                        const extension = isMP3 ? 'mp3' : 'txt';
                        fileName = `語音腳本_高品質_${timestamp}.${extension}`;
                        message = isMP3 
                            ? '🎵 高品質 MP3 檔案下載開始！這是您的完整語音腳本檔案。'
                            : '📄 文本檔案下載開始！如需 MP3 檔案，請設定 Google Cloud API Key。';
                    } else {
                        // 免費模式：下載錄製的音頻檔案
                        const isAudio = this.currentBlob.type.startsWith('audio/');
                        if (isAudio) {
                            fileName = `語音腳本_免費版_${timestamp}.webm`;
                            message = '🎵 音頻檔案下載開始！這是使用瀏覽器語音錄製的檔案。';
                        } else {
                            fileName = `語音腳本_免費版_${timestamp}.txt`;
                            message = '📄 文本檔案下載開始！';
                        }
                    }
                    
                    const url = URL.createObjectURL(this.currentBlob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = fileName;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    this.showMessage(message, 'success');
                    
                } else if (!this.isPremiumMode && this.scriptItems.length > 0) {
                    // 備用方案：生成腳本文字檔案
                    this.generateScriptTextFile();
                } else {
                    this.showMessage('請先生成語音檔案', 'error');
                }
            }
            
            generateScriptTextFile() {
                // 建立詳細的腳本內容
                let scriptContent = '🎯 英文口說出題系統 - 語音腳本\n';
                scriptContent += '=' .repeat(50) + '\n\n';
                scriptContent += `生成時間：${new Date().toLocaleString('zh-TW')}\n`;
                scriptContent += `模式：免費模式 (瀏覽器內建語音)\n`;
                scriptContent += `腳本項目數量：${this.scriptItems.length}\n\n`;
                
                scriptContent += '📝 完整腳本內容：\n';
                scriptContent += '-'.repeat(30) + '\n\n';
                
                let itemNumber = 1;
                for (const item of this.scriptItems) {
                    if (item.type === 'text') {
                        scriptContent += `${itemNumber}. 📢 文字朗讀\n`;
                        scriptContent += `   內容：${item.text}\n`;
                        scriptContent += `   語音：${item.voice}\n\n`;
                        itemNumber++;
                    } else if (item.type === 'pause') {
                        scriptContent += `${itemNumber}. ⏸️ 暫停時間\n`;
                        scriptContent += `   時長：${item.duration} 秒\n\n`;
                        itemNumber++;
                    }
                }
                
                scriptContent += '\n' + '='.repeat(50) + '\n';
                scriptContent += '💡 使用說明：\n';
                scriptContent += '• 此檔案包含完整的語音腳本內容\n';
                scriptContent += '• 免費模式使用瀏覽器內建語音引擎\n';
                scriptContent += '• 如需高品質 MP3 檔案，請切換到高品質模式\n';
                scriptContent += '• 可將此腳本匯入其他語音合成軟體使用\n\n';
                
                scriptContent += '🔗 相關連結：\n';
                scriptContent += '• Google Cloud Text-to-Speech: https://cloud.google.com/text-to-speech\n';
                scriptContent += '• Microsoft Speech Platform: https://www.microsoft.com/cognitive-services/speech\n';
                scriptContent += '• Amazon Polly: https://aws.amazon.com/polly/\n\n';
                
                scriptContent += `檔案生成於：${new Date().toISOString()}\n`;
                
                // 建立並下載檔案
                const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
                const fileName = `語音腳本_免費版_${timestamp}.txt`;
                
                const blob = new Blob([scriptContent], { type: 'text/plain;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = fileName;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                this.showMessage(`
                    📄 <strong>腳本文字檔案下載完成！</strong><br><br>
                    ✅ 檔案包含完整的語音腳本內容<br>
                    ✅ 可匯入其他語音合成軟體使用<br>
                    ✅ 包含詳細的設定參數和使用說明<br><br>
                    💡 <strong>提示：</strong>如需真正的 MP3 音頻檔案，請切換到高品質模式並設定 Google Cloud API Key
                `, 'success');
            }
            
            showMessage(message, type) {
                this.statusMessage.innerHTML = `<div class="${type}">${message}</div>`;
                
                // API 設定錯誤訊息不自動消失，其他訊息 8 秒後消失
                if (type === 'success' || (type === 'error' && !message.includes('API 尚未啟用'))) {
                    setTimeout(() => {
                        this.statusMessage.innerHTML = '';
                    }, 8000);
                }
            }
        }
        
        // 全域變數供 HTML 事件使用
        let generator;
        
        // 頁面載入完成後初始化
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                generator = new ScriptBasedSpeechGenerator();
            });
        } else {
            generator = new ScriptBasedSpeechGenerator();
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'994f285423e94a3c',t:'MTc2MTUzNjI3NC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
